
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Запуск сервиса, и использование сетевых интерфейсов &mdash; Specification of the Exim Mail Transfer Agent 4.70 documentation</title>
    
    <link rel="stylesheet" href="_static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '4.70',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <link rel="top" title="Specification of the Exim Mail Transfer Agent 4.70 documentation" href="index.html" />
    <link rel="next" title="Главная конфигурация" href="ch14.html" />
    <link rel="prev" title="Встроенный Perl" href="ch12.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="_static/small_flask.css" type= "text/css" rel="stylesheet" />

  </head>
  <body>
    <div class="related">
      <h3>Просмотр</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="Словарь-указатель"
             accesskey="I">словарь</a></li>
        <li class="right" >
          <a href="ch14.html" title="Главная конфигурация"
             accesskey="N">следующий</a> |</li>
        <li class="right" >
          <a href="ch12.html" title="Встроенный Perl"
             accesskey="P">предыдущий</a> |</li>
        <li><a href="index.html">Specification of the Exim Mail Transfer Agent 4.70 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="ch13-00">
<span id="id1"></span><h1>Запуск сервиса, и использование сетевых интерфейсов<a class="headerlink" href="#ch13-00" title="Ссылка на этот заголовок">¶</a></h1>
<p>Хост, который связан сетью TCP/IP, может иметь один, или более, аппаратных (физических) сетевых интерфейсов. Каждый из этих интерфейсов может быть сконфигурирован как один или несколько “логических” интерфейсов, с которыми, фактически, работает программа. Каждый из этих логических интерфейсов ассоциирован с IP-адресом. Кроме того, программное обеспечение TCP/IP поддерживает “loopback”-интерфейсы (“127.0.0.1” в IPv4 и “::1” в IPv6), которые не используют какое-либо физическое устройство. Exim`у требуется информация о интерфейсах хоста для использования в трёх различных обстоятельствах:</p>
<ol class="arabic simple">
<li>Когда запущен слушающий сервис, Exim должен знать, какие интерфейсы и порты ему нужно слушать.</li>
<li>Когда Exim маршрутизирует адрес, он должен знать, какие IP-адреса ассоциированы с локальными интерфейсами. Это требуется для корректной обработки списков MX, удаляя локальный хост и прочие, с такими же или более высоко-приоритетными значениями. Также, Exim должен обнаруживать случаи, когда адрес маршрутизируется на IP адрес принадлежащий локальному хосту. За исключением параметра <strong>self</strong> в маршрутизаторе, или если параметр <strong>allow_localhost</strong> в SMTP-транспорте установлен (как соответствующая), это обрабатывается как ошибочная ситуация <a class="footnote-reference" href="#id10" id="id2">[1]</a></li>
<li>Когда Exim коннектится к удалённому хосту, ему может быть необходимым знать, какой интерфейс использовать для исходящего соединения.</li>
</ol>
<p>Поведение по умолчанию Exim`a, вероятно, будет подходящим, в подавляющем большинстве случаев. Если у вашего хоста лишь один интерфейс, и вы хотите, чтобы все его IP-адреса были обработаны одинаково, и вы используете стандартный SMTP-порт, то вы не должны предпринимать каких-либо специальных действий. Остальная часть этой главы к вам не относится.</p>
<p>В более сложных ситуациях, вам может быть необходимо слушать только на определённых интерфейсах, или на различных портах, и для этого есть много параметров, которые можно использовать для влияния на поведение Exim`a. Остальная часть этой главы описывает, как они работают.</p>
<p>Когда сообщение получено через TCP/IP, интерфейс и порт, которые фактически использовались, установлены в переменных <tt class="docutils literal"><span class="pre">$received_ip_address</span></tt> и <tt class="docutils literal"><span class="pre">$received_port</span></tt>.</p>
<div class="section" id="ch13-01">
<span id="id3"></span><h2>Запуск слушающего сервиса<a class="headerlink" href="#ch13-01" title="Ссылка на этот заголовок">¶</a></h2>
<p>Когда слушающий сервис запущен (с параметром командной строки <strong>-bd</strong>), интерфейсы и порты на которых он слушает управляются следующими параметрами:</p>
<ul class="simple">
<li><strong>daemon_smtp_ports</strong> содержит список портов по умолчанию. (для обратной совместимости, этот параметр также может быть задана в единственном числе.)</li>
<li><strong>local_interfaces</strong> содержит список IP адресов интерфейсов, которые слушаются. Каждый элемент также необязательно может определять порт.</li>
</ul>
<p>В обоих случаях, разделитель списка по умолчанию - двоеточие, но он может быть изменён, как описано в разделе <a class="reference internal" href="ch06.html#ch06-19"><em>6.19</em></a>. Когда используются адреса IPv6, обычно, лучше изменять разделитель, чтобы избежать необходимости удваивать все двоеточия. Например:</p>
<div class="highlight-python"><pre>local_interfaces = &lt;; 127.0.0.1 ; \
                      192.168.23.65 ; \
                      ::1 ; \
                      3ffe:ffff:836f::fe86:a061</pre>
</div>
<p>Есть два различных формата для задания порта с IP-адресом в <strong>local_interfaces</strong>:</p>
<ol class="arabic">
<li><p class="first">Порт добавлен в адрес, с разделеителем в виде точки. Например, для прослушивания порта 1234 на двух различных адресах:</p>
<div class="highlight-python"><pre>local_interfaces = &lt;; 192.168.23.65.1234 ; \
                      3ffe:ffff:836f::fe86:a061.1234</pre>
</div>
</li>
<li><p class="first">IP-адрес заключается в квадратные скобки, и порт добавляется с разделителем в виде двоеточия, например:</p>
<div class="highlight-python"><pre>local_interfaces = &lt;; [192.168.23.65]:1234 ; \
                      [3ffe:ffff:836f::fe86:a061]:1234</pre>
</div>
</li>
</ol>
<p>Когда порт не задан, используется значение <strong>daemon_smtp_ports</strong>. Настройка по умолчанию содержит лишь один порт:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">daemon_smtp_ports</span> <span class="o">=</span> <span class="n">smtp</span>
</pre></div>
</div>
<p>Если перечислено более одного порта, каждый интерфейс, для которого не определён его собственный порт, слушает каждый из них. Порты перечисленные в <strong>daemon_smtp_ports</strong> могут быть идентифицированы по имени (определённому в <em>/etc/services</em>), или по номеру. Однако, когда порты даны в с индивидуальными IP-адресами в <strong>local_interfaces</strong>, только номера (не имена) могут использоваться.</p>
</div>
<div class="section" id="ip">
<span id="ch13-02"></span><h2>Специальный IP слушающий адреса<a class="headerlink" href="#ip" title="Ссылка на этот заголовок">¶</a></h2>
<p>Адрес 0.0.0.0 и ::0 обрабатываются особенно. Они интерпретируются как “все интерфейсы IPv4” и “все интерфейсы IPv6”, соответственно. В каждом случае, Exim говорит стеку TCP/IP “слушать на всех интерфейсах IPvx” вместо установки отдельных слушающих сокетов для каждого интерфейса. Значение по умолчанию <strong>local_interfaces</strong>:</p>
<div class="highlight-python"><pre>local_interfaces = 0.0.0.0</pre>
</div>
<p>когда Exim собран без поддержки IPv6; иначе оно:</p>
<div class="highlight-python"><pre>local_interfaces = &lt;; ::0 ; 0.0.0.0</pre>
</div>
<p>Таким образом, по умолчанию, Exim слушает все доступные интерфейсы, на SMTP-порту.</p>
</div>
<div class="section" id="local-interfaces-daemon-smtp-ports">
<span id="ch13-03"></span><h2>Отмена <strong>local_interfaces</strong> и <strong>daemon_smtp_ports</strong><a class="headerlink" href="#local-interfaces-daemon-smtp-ports" title="Ссылка на этот заголовок">¶</a></h2>
<p>Параметр командной строки <strong>-oX</strong> может быть использована для переопределения значений <strong>daemon_smtp_ports</strong> и/или <strong>local_interfaces</strong> для специфического случая сервиса. Другой способ сделать это состоял бы в использовании макроса и параметра <strong>-D</strong>. Однако, <strong>-oX</strong> может использоваться лишь административными пользователями, тогда как модификация рабочей конфигурации, использованием параметра <strong>-D</strong>, разрешена только когда вызывающий - root или пользователь Exim`a.</p>
<p>Значение <strong>-oX</strong> - список значений. Разделитель по умолчанию, двоеточие, может быть изменён обычным способом, если требуется. Если есть элементы не содержащие точек или двоеточий (т.е. не IP адреса), значение <strong>daemon_smtp_ports</strong> заменяется списком этих элементов. Если тут есть какие-то пункты содержащие точки или двоеточия, значение <strong>local_interfaces</strong> заменяется этими элементами. Таким образом, например:</p>
<div class="highlight-python"><pre>-oX 1225</pre>
</div>
<p>замещает <strong>daemon_smtp_ports</strong>, но оставляет <strong>local_interfaces</strong> неизменным, тогда как</p>
<div class="highlight-python"><pre>-oX 192.168.34.5.1125</pre>
</div>
<p>замещает <strong>local_interfaces</strong>, оставляя  неизменным <strong>daemon_smtp_ports</strong>. (Однако, с этого момента <strong>local_interfaces</strong> не содержит элементов без портов, и в этом примере значение <strong>daemon_smtp_ports</strong> неуместно.)</p>
</div>
<div class="section" id="ssmtp-smtps">
<span id="ch13-04"></span><h2>Поддержка устаревшего протокола SSMTP (или SMTPS)<a class="headerlink" href="#ssmtp-smtps" title="Ссылка на этот заголовок">¶</a></h2>
<p>Exim поддерживает устаревший протокол SSMTP (также известный как SMTPS), который использовался прежде чем для SNMP была стандартизована команда STARTTLS. Некоторые старый клиенты до сих пор используют этот протокол. Если параметр <strong>tls_on_connect_ports</strong> установлена в список портов, подключение к этим портам должно использовать SSMTP. Обычное использование этого параметра - такое:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">tls_on_connect_ports</span> <span class="o">=</span> <span class="mi">465</span>
</pre></div>
</div>
<p>поскольку 465 - обычный порт используемый старыми клиентами. Также есть параметр командной строки <strong>-tls-on-connect</strong>, которая вынуждает все порты вести себя так, при старте сервиса.</p>
<div class="admonition warning">
<p class="first admonition-title">Предупреждение</p>
<p class="last">Установка <strong>tls_on_connect_ports</strong> не вынуждает сервис слушать перечисленные в ней порты. Вы всё равно должны задать <strong>daemon_smtp_ports</strong>, <strong>local_interfaces</strong> или <strong>-oX</strong>. (Это так, потому что <strong>tls_on_connect_ports</strong> обращается к подключениям через <strong>inetd</strong> также, как и к подключениям через сервис)</p>
</div>
</div>
<div class="section" id="ipv6">
<span id="ch13-05"></span><h2>Области адресов IPv6<a class="headerlink" href="#ipv6" title="Ссылка на этот заголовок">¶</a></h2>
<p>Адреса IPv6 имеют “области” (“scopes”), и хост с многими аппаратными интерфейсами, в принцмпе, может иметь один и тотже локальный <a class="footnote-reference" href="#id11" id="id4">[2]</a> адрес IPv6 на различных интерфейсах. Таким образом, необходима дополнительная информация, кроме IP-адреса, чтобы различать индивидуальные интерфейсы. В некоторых случаях, было принято соглашение, о использовании символа процента, сопровождаемого чем-либо (часто - именем интерфейса), приводя к адресам вроде такого:</p>
<div class="highlight-python"><pre>fe80::202:b3ff:fe03:45c1%eth0</pre>
</div>
<p>Для согласования этого использования, символ процента, сопровождаемый произвольной строкой, разрешён в конце адреса IPv6. По умолчанию, Exim вызывает <em>getaddrinfo()</em>, чтобы преобразовать текстовый адрес IPv6 для фактического использования. Эта функция распознаёт соглашение процента в операционных системах, которые поддерживают его, и соответственно обрабатывают адрес. К сожалению, некоторые старые библиотеки имеют проблемы с <em>getaddrinfo()</em>. Если</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">IPV6_USE_INET_PTON</span><span class="o">=</span><span class="n">yes</span>
</pre></div>
</div>
<p>установлена в <em>Local/Makefile</em> (или в ОС-зависимом Makefile) когда Exim собирается, Exim использует <em>inet_pton()</em> для конвертации текстового адреса IPv6 в реально используемый, вместо <em>getaddrinfo()</em>. (До версии 4.14, всегда использовалась эта функция.) Конечно, это означает, что дополнительные возможности <em>getaddrinfo()</em> - распознание областей адресов - потеряны.</p>
</div>
<div class="section" id="ch13-06">
<span id="id5"></span><h2>Отключение IPv6<a class="headerlink" href="#ch13-06" title="Ссылка на этот заголовок">¶</a></h2>
<p>Иногда случается, что бинарник Exim`a собранный с поддержкой IPv6, запускается на хосте, ядро которого не знает о IPv6. Бинарник продолжает использовать IPv4, но это может вызывать пустую растрату ресурсов на поиск AAAA записей, и попыток коннекта к адресам IPv6, вызывающие задержки в доставке почты. Если вы установите параметр <strong>disable_ipv6</strong> в “истина”, даже когда бинарник Exim`a поддерживает IPv6, IPv6 не активируется. AAAA записи никогда не ищутся, и любые адреса IPv6 перечисленные в <strong>local_interfaces</strong>, данных для маршрутизатора <strong>manualroute</strong> и т.д. - игнорируются. Eсли IP литералы включены <a class="footnote-reference" href="#id12" id="id6">[3]</a>, vfhihenbpfnjh <strong>ipliteral</strong> отказывается обрабатывать адреса IPv6.</p>
<p>С другой стороны, когда используется IPv6, могут быть моменты, когда вы хотите отключить его для определённых хостов или доменов. Вы можете использовать параметр <strong>dns_ipv4_lookup</strong> для глобального подавления поиска AAAA записей для указанных доменов, и можете использовать общий параметр маршрутизаторов <strong>ignore_target_hosts</strong>, для игнорирования адресов IPv6 в отдельном маршрутизаторе.</p>
</div>
<div class="section" id="ch13-07">
<span id="id7"></span><h2>Примеры запуска слушающего сервиса<a class="headerlink" href="#ch13-07" title="Ссылка на этот заголовок">¶</a></h2>
<p>Случай по умолчанию в среде IPv6 таков:</p>
<div class="highlight-python"><pre>daemon_smtp_ports = smtp
local_interfaces = &lt;; ::0 ; 0.0.0.0</pre>
</div>
<p>Этим определяется слушать smtp-порт на всех интерфейсах IPv4 и IPv6. Могут использоваться один или два сокета, в зависимости от характеристик стека TCP/IP. (Это запутанно, и беспорядочно; для дополнительной информации прочтите комментарии в файле исходников <em>daemon.c</em>)</p>
<p>Для задания прослушивания портов 25 и 26 на всех интерфейсах:</p>
<div class="highlight-python"><pre>daemon_smtp_ports = 25 : 26</pre>
</div>
<p>(оставляя <strong>local_interfaces</strong> с настройками по умолчанию), или, более явно:</p>
<div class="highlight-python"><pre>local_interfaces = &lt;; ::0.25     ; ::0.26 \
                        0.0.0.0.25 ; 0.0.0.0.26</pre>
</div>
<p>Для того, чтобы слушать на порту по умолчанию всех IPv4 интерфейсов и порту 26, только на адресе обратной петли:</p>
<div class="highlight-python"><pre>local_interfaces = 0.0.0.0 : 127.0.0.1.26</pre>
</div>
<p>Для того, чтобы слушать на порту умолчанию, только на специфических интерфейсах:</p>
<div class="highlight-python"><pre>local_interfaces = 192.168.34.67 : 192.168.34.67</pre>
</div>
<div class="admonition warning">
<p class="first admonition-title">Предупреждение</p>
<p class="last">Такая установка исключает прослушивание интерфейса обратной петли.</p>
</div>
</div>
<div class="section" id="ch13-08">
<span id="id8"></span><h2>Распознание локального хоста<a class="headerlink" href="#ch13-08" title="Ссылка на этот заголовок">¶</a></h2>
<p>Параметр <strong>local_interfaces</strong> также используется, когда Exim`y необходимо определить, действительно ли IP адрес относится к локальному хосту. Таким образом, все IP-адреса, на которых слушает сервис, всегда обрабатываются как локальные.</p>
<p>Для этого использования, номера портов в <strong>local_interfaces</strong> игнорируются. Если встречается один из двух элементов 0.0.0.0” или ::0, Exim получает полный список доступных интерфейсов от операционной системы, и извлекает уместные (т.е. IPv4 или IPv6) адреса, чтобы использовать для проверки.</p>
<p>Некоторые системы устанавливают большое число вирутальных интерфейсов, для обеспечения большого числа виртуальных серверов в сети. В этой ситуации, вы можете захотеть слушать лишь некоторые доступные интерфейсы для получения почты, но обрабатывать все локальные интерфейсы как местные, при маршрутизации. Вы можете сделать это установкой <strong>extra_local_interfaces</strong> в список IP-адресов, возможно, включая подстановочное значение “все”. Эти адреса распознаются как локальные, но не используются для прослушивания. Рассмотрите этот пример:</p>
<div class="highlight-python"><pre>local_interfaces = &lt;; 127.0.0.1 ; ::1 ; \
                      192.168.53.235 ; \
                      3ffe:2101:12:1:a00:20ff:fe86:a061

extra_local_interfaces = &lt;; ::0 ; 0.0.0.0</pre>
</div>
<p>сервис слушает на интерфейсе обратной петли, и лишь на одном адресе IPv4 и одном адресе IPv6, но все доступные интерфейсы обрабатываются как локальные, при маршрутизации.</p>
<p>В некотором количестве окружения, имя локального хоста может быть в списке MX, но с IP-адресом не назначенным ни одному местному интерфейсу. В других случаях, может быть желательным обработать другие имена хостов, как будто они ссылаются на локальный хост. Оба этих случая могут быть обработаны установкой параметра <strong>hosts_treat_as_local</strong>. Он содержит имена хостов, а не IP-адреса. Когда на хост ссылаются в процессе маршрутизации, или через MX-запись, или непосредственно, он обрабатывается как локальный хост, если его имя совпадает с <strong>hosts_treat_as_local</strong>, или если любой из его IP-адресов совпадает с <strong>local_interfaces</strong> или <strong>extra_local_interfaces</strong>.</p>
</div>
<div class="section" id="ch13-09">
<span id="id9"></span><h2>Доставка к удалённому хосту<a class="headerlink" href="#ch13-09" title="Ссылка на этот заголовок">¶</a></h2>
<p>Доставка к удалённому хосту обрабатывается smtp-транспортом. По-умолчанию, это позволяет системным функциям TCP/IP выбирать, какой интерфейс использовать (если их больше одного) при соединении с удалённым хостом. Однако, параметром <strong>interface</strong> может быть установлено, какой интерфейс использовать. Смотрите описание smtp-транспотра в главе <a class="reference internal" href="ch30.html#ch30-00"><em>30</em></a>, для получения дополнительных деталей.</p>
<table class="docutils footnote" frame="void" id="id10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td>наверно, речь идёт о маршрутизации адреса на свой собственный хост - прим. lissyara.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[2]</a></td><td>не до конца понятно, в документации это обозвано link-local - локальный, или локально ссылающийся, чтоли... Не очень я знаю IPv6 - прим. lissyara</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id12" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[3]</a></td><td>доставка не по имени а по IP - прим. lissyara</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Содержание</a></h3>
  <ul>
<li><a class="reference internal" href="#">Запуск сервиса, и использование сетевых интерфейсов</a><ul>
<li><a class="reference internal" href="#ch13-01">Запуск слушающего сервиса</a></li>
<li><a class="reference internal" href="#ip">Специальный IP слушающий адреса</a></li>
<li><a class="reference internal" href="#local-interfaces-daemon-smtp-ports">Отмена <strong>local_interfaces</strong> и <strong>daemon_smtp_ports</strong></a></li>
<li><a class="reference internal" href="#ssmtp-smtps">Поддержка устаревшего протокола SSMTP (или SMTPS)</a></li>
<li><a class="reference internal" href="#ipv6">Области адресов IPv6</a></li>
<li><a class="reference internal" href="#ch13-06">Отключение IPv6</a></li>
<li><a class="reference internal" href="#ch13-07">Примеры запуска слушающего сервиса</a></li>
<li><a class="reference internal" href="#ch13-08">Распознание локального хоста</a></li>
<li><a class="reference internal" href="#ch13-09">Доставка к удалённому хосту</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="ch12.html" title="предыдущая глава">Встроенный Perl</a></li>
      <li>Next: <a href="ch14.html" title="следующая глава">Главная конфигурация</a></li>
  </ul></li>
</ul>
  <h3>На этой странице</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/ch13.txt"
           rel="nofollow">Показать исходный текст</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Быстрый поиск</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Искать" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Введите слова для поиска или имя модуля, класса или функции.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy; Copyright 2011, Exim Maintainers.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
    </div>
  </body>
</html>
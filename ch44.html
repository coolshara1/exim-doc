
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Обработка сообщения &mdash; Specification of the Exim Mail Transfer Agent 4.70 documentation</title>
    
    <link rel="stylesheet" href="_static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '4.70',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <link rel="top" title="Specification of the Exim Mail Transfer Agent 4.70 documentation" href="index.html" />
    <link rel="next" title="Обработка SMTP" href="ch45.html" />
    <link rel="prev" title="Системная фильтрация сообщений" href="ch43.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="_static/small_flask.css" type= "text/css" rel="stylesheet" />

  </head>
  <body>
    <div class="related">
      <h3>Просмотр</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="Словарь-указатель"
             accesskey="I">словарь</a></li>
        <li class="right" >
          <a href="ch45.html" title="Обработка SMTP"
             accesskey="N">следующий</a> |</li>
        <li class="right" >
          <a href="ch43.html" title="Системная фильтрация сообщений"
             accesskey="P">предыдущий</a> |</li>
        <li><a href="index.html">Specification of the Exim Mail Transfer Agent 4.70 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="ch44-00">
<span id="id1"></span><h1>Обработка сообщения<a class="headerlink" href="#ch44-00" title="Ссылка на этот заголовок">¶</a></h1>
<p>Exim выполняет различные преобразования адресов отправителей и получателей для всех обрабатываемых сообщений, и, также, строк заголовков. Некоторые из них - необязательны и настраиваемые, тогда как другие присутствуют всегда. Вся эта обработка, исключая перезапиь как результат маршрутизации, и добавления/удаления строк заголовков при доставке, происходит при приёме сообщения, до его помещения в очередь Exim&#8217;a.</p>
<p>Часть автоматической обработки, по умолчанию, происходит лишь для “порожденных локально” (“locally-originated”) сообщений. Это прилагательное используется для описания сообщений которые не были переданы через TCP/IP, а переданы процессу Exim&#8217;a на его стандартный ввод. Оно включает случай интерактивного “локального SMTP”, который устанавливается параметром <strong>-bs</strong>, командной строки.</p>
<ol class="upperalpha simple" start="5">
<li>note:: Сообщения переданные через TCP/IP на интерфейсе обратной петли (<em>127.0.0.1</em> или <em>::1</em>), не рассматриваются как поражденные локально. Exim никогда не обрабатывает особым образом интерфейс локальной петли.</li>
</ol>
<blockquote>
<div>Если вы хотите обработать интерфейс локальной петли особым образом, вы должны гарантировать, что существуют соответствующие записи в ваших ACL.</div></blockquote>
<div class="section" id="ch44-01">
<span id="id2"></span><h2>Режим передачи для нелокальных сообщений<a class="headerlink" href="#ch44-01" title="Ссылка на этот заголовок">¶</a></h2>
<p>Происходящую автоматически обработку для локально порожденных сообщений (если не установлен параметр <strong>suppress_local_fixups</strong>), также можно затребовать для сообщений полученных по TCP/IP. Термин “режим передачи” (“submission mode”) используется для описания этого состояния. Режим передачи устанавливается при помощи модификатора</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">control</span> <span class="o">=</span> <span class="n">submission</span>
</pre></div>
</div>
<p>в MAIL, RCPT, или ACL до данных, для входящего сообщения (смотрите разделы <a class="reference internal" href="ch40.html#ch40-19"><em>40.19</em></a> и <a class="reference internal" href="ch40.html#ch40-20"><em>40.20</em></a>). Он заставляет Exim обработать сообщение как переданное локально, и, обычно, используется для когда источник сообщения известен как MUA, работающий на клиентском хосте (в противоположность MTA). Например, для установки режима передачи для сообщений приходящих на IPv4 интерфейсе обратной петли, вы могли включить следующее в MAIL ACL:</p>
<div class="highlight-python"><pre>warn  hosts = 127.0.0.1
      control = submission</pre>
</div>
<p>Есть некоторые параметры, которые могут использоваться когда установлен режим передачи. Слэш используется для разделения параметров. Например:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">control</span> <span class="o">=</span> <span class="n">submission</span><span class="o">/</span><span class="n">sender_retain</span>
</pre></div>
</div>
<p>Указание <strong>sender_retain</strong> имеет эффект установки параметра <strong>local_sender_retain</strong> равным “true” и <strong>local_from_check</strong> равной “false” для текущего входящего сообщения. Первая из них позволяет сохранять существующий заголовок “Sender:”, второй параметр подавляет проверку заголовка “From:” на соответствие с аутентифицированным пользователем. С этим параметром Exim по прежнему добавляет до сообщения заголовки “Date:” и “Message-ID:”, если они отсутствуют, но не пробует проверить отправителя из строк заголовка.</p>
<p>Когда <strong>sender_retain</strong> не установлен, настройки режима передачи могут задавать домен, который будет использоваться при создании заголовков “From:” или “Sender:”. Например:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">control</span> <span class="o">=</span> <span class="n">submission</span><span class="o">/</span><span class="n">domain</span><span class="o">=</span><span class="n">some</span><span class="o">.</span><span class="n">domain</span>
</pre></div>
</div>
<p>Домен может быть пустым. Как это значение используется - описано в разделах <a class="reference internal" href="#ch44-11"><em>44.11</em></a> и <a class="reference internal" href="#ch44-16"><em>44.16</em></a>. Также, есть параметр <strong>name</strong>, которая позволяет вам задать полное имя пользователя для включения в создаваемые заголовки “Sender:” и “From:”. Например:</p>
<div class="highlight-python"><pre>accept authenticated = *
       control = submission/domain=wonderland.example/\
                            name=${lookup {$authenticated_id} \
                            lsearch {/etc/exim/namelist}}</pre>
</div>
<p>Поскольку имя может содержать любые символы, включая слэши, параметр <strong>name</strong> должна быть дана последней. Оставшаяся строка используется как имя. Для примера выше, если <em>/etc/exim/namelist</em> содержит:</p>
<div class="highlight-python"><pre>bigegg:  Humpty Dumpty</pre>
</div>
<p>тогда, когда отправитель аутентифицирован как <em>bigegg</em>, созданная строка “Sender:” была бы:</p>
<div class="highlight-python"><pre>Sender: Humpty Dumpty &lt;bigegg@wonderland.example&gt;</pre>
</div>
<p>По умолчанию, режим передачи принудительно ставит путь возврата в тот же адрес, что используется для создания заголовка “Sender:”. Однако, если задана <strong>sender_retain</strong>, путь возврата также остаётся неизменным.</p>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last">изменения вызванные режимом передачи вступают в силу после ACL перед данными. Это означает, что любые проверки отправителя выполненные перед адресными привязками используют ненадёжный адрес отправителя заданный пользователем, а не надёжным адресом отправителя заданным режимом передачи. Хотя это несколько неожиданно, в действительности это означает, что вы можете настроить проверки ACL на определение что пользователь пробует сфабриковать иной адрес.</p>
</div>
</div>
<div class="section" id="ch44-02">
<span id="id3"></span><h2>Завершения строк<a class="headerlink" href="#ch44-02" title="Ссылка на этот заголовок">¶</a></h2>
<p><span class="target" id="index-0"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2821.html"><strong>RFC 2821</strong></a> задаёт, что CRLF (два символа: возврат каретки, сопровождаемый переводом строки) - конец сообщений передаваемых через интернет, используя SMTP через TCP/IP. Однако, в отдельных операционных системах, используются иные соглашения. Например, UNIX-подобные системы используют лишь LF, но иные используют CRLF или просто CR.</p>
<p>Exim был разработан для UNIX-подобных систем, и внутренне, он сохраняет сообщения используя системное соглашение единственного LF как терминатора строки. Получая сообщение, все концы строк переводятся в этот стандартный формат. Изначально, предполагалось, что программы передающие сообщения напрямую к MTA, внутри операционной системы, будут использовать системные соглашения. Опыт показал, что это не так; например, существуют UNIX-приложения, которые в этом случае используют CRLF. Поэтому, и для совместимости с другими MTA, способы, которыми Exim обрабатывает концы строк для всех сообщений, на данный момент, - таковы:</p>
<ul class="simple">
<li>LF, которму не предшествовал CR - обрабатывается как завершение строки.</li>
<li>CR - обрабатывается как конец строки; если сразу за ним идёт LF, LF игнорируется.</li>
<li>Последовательность “CR, точка, CR” не завершает входящее SMTP-сообщение, ни локальное сообщение, в случае когда строка содержащая лишь точку - терминатор.</li>
<li>Если в стрке заголовка найден лишь CR, после завершения строки добавляется дополнительное пустое пространство, чтобы не завершить строку заголовка. Рассуждения таковы, что пустые CR в заголовках, наиболее вероятно, ошибки, или люди пробующие игоать в глупые игры.</li>
<li>Если первая строка заголовка в сообщении завершается CRLF, последующие пустые LF в строке заголовка обрабатывается точно также как и пустой CR в строке заголовка.</li>
</ul>
</div>
<div class="section" id="ch44-03">
<span id="id4"></span><h2>Неквалифицированные адреса<a class="headerlink" href="#ch44-03" title="Ссылка на этот заголовок">¶</a></h2>
<p>По умолчанию, Exim ожидает, что каждый, получаемый с внешнего хоста, адрес конверта, будет полностью квалифицирован (с доменным именем). Неквалифицированные адреса вызывают отрицательные ответы на команды SMTP. Однако, поскольку SMTP используется для как средство транспортировки сообщений от MUA работающих на персональных рабочих станциях, иногда требуется принимать неквалифицированные адреса от специфических хостов или IP-сетей.</p>
<p>У Exim&#8217;a есть два параметра, которые раздельно управляют тем, какие хосты могут посылать неквалифицированные адреса отправителей или получателей в SMTP-командах, именуемые <strong>sender_unqualified_hosts</strong> и <strong>recipient_unqualified_hosts</strong>. В обоих случаях, если принимаются неквалифицированные адреса, они квалифицируются путём добавления значения <strong>qualify_domain</strong> или <strong>qualify_recipient</strong>, соответственно.</p>
<p>Неквалифицированные адреса в строках заголовков, автоматически квалифицируются для порожденных локально сообщений, если в командной строке не задан параметр <strong>-bnq</strong>. Для сообщений принятых по SMTP, неквалифицированные адреса, в заголовках, квалифицируются лишь если в SMTP-командах разрешены неквалифицированные адреса. Другими словами, этой квалификацией также управляют путём <strong>sender_unqualified_hosts</strong> и <strong>recipient_unqualified_hosts</strong>.</p>
</div>
<div class="section" id="from-uucp">
<span id="ch44-04"></span><h2>Строка “From” UUCP<a class="headerlink" href="#from-uucp" title="Ссылка на этот заголовок">¶</a></h2>
<p>Сообщения приходящие из UUCP (и некоторых других приложений), часто, начинаются со строки содержащей отправителя конверта и штамп времени, после слова “From”. Примеры двух обычных форматов:</p>
<div class="highlight-python"><pre>From a.oakley@berlin.mus Fri Jan  5 12:35 GMT 1996
From f.butler@berlin.mus Fri, 7 Jan 97 14:00:00 GMT</pre>
</div>
<p>Эта строка предшествует строкам заголовков, соответствующим <span class="target" id="index-1"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2822.html"><strong>RFC 2822</strong></a>. Для совместимости с Sendmail, Exim распознаёт такие строки как начало сообщения переданного через командную строку (т.е. на стандартном вводе). Он не распознаёт такие строки во входящих сообщениях, если посылающий хост не совпадает с <strong>ignore_fromline_hosts</strong>, или не использовался параметр <strong>-bs</strong> для локального сообщения, при установленной <strong>ignore_fromline_hosts</strong>. Распознание управляется регулярным выражением, которое задано параметром <strong>uucp_from_pattern</strong>, чьё значение по умолчанию совпадает с двумя частыми случаями, показанными выше, и помещает адреса следующие за “From” в “$1”.</p>
<p>Когда пользователь, вызывающий Exim для не-SMTP сообщения содержащего строку “From” - доверенный пользователь, адрес отправителя сообщения конструируется путём раскрытия содержимого <strong>uucp_sender_address</strong>, чьё значение по умолчанию - “$1”. Затем оно разбирается как адрес по <span class="target" id="index-2"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2822.html"><strong>RFC 2822</strong></a>. Если в нём нет домена, локальная часть квалифицируется с <strong>qualify_domain</strong>, если оно - не пустая строка. Однако, если используется параметр командной строки <strong>-f</strong>, она перезадаёт строку “From”.</p>
<p>Если Exim вызывает не доверенный пользователь, строка “From” распознаётся, но адрес отправителя не изменяется. Для входящих SMTP сообщений с разрешённой строкой “From”, применяется этот же случай.</p>
<p>Распознаётся лишь одна строка “From”. Если их больше одной, вторая обрабатывается как строка данных, которая начинает тело сообщения, поскольку она - не допустимая строка заголовка. Также это происходит если строка “From” представлена во входящем SMTP-сообщении от источника, которму его не разрешено посылать.</p>
</div>
<div class="section" id="resent">
<span id="ch44-05"></span><h2>Строки заголовков <strong>Resent-</strong><a class="headerlink" href="#resent" title="Ссылка на этот заголовок">¶</a></h2>
<p><span class="target" id="index-3"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2822.html"><strong>RFC 2822</strong></a> создаёт условия для добавления в сообщение строк заголовков начинающихся со строки “Resent-”, когда оно пересылается оригинальным получателем ещё кому-то. Эти заголовки - “Resent-Date:”, “Resent-From:”, “Resent-Sender:”, “Resent-To:”, “Resent-Cc:”, “Resent-Bcc:” и “Resent-Message-ID:”. В RFC говорится:</p>
<p><em>Повторно посланные поля являются строго информационными. Они НЕ ДОЛЖНЫ использоваться в нормальной обработке ответов, или других подобных автоматических действиях для сообщений.</em></p>
<p>Этим оставляются несколько неопределённым, насколько затронуты другие действия обработки, типа перезаписи адресов. Exim обрабатывает строки заголовков <strong>Resent-</strong> следующим образом:</p>
<ul class="simple">
<li>Строка “Resent-From:” - содержит лишь логин передающего пользователя, и автоматически перезаписывается точно таким же способом как “From:” (смотрите ниже).</li>
<li>Если есть правило перезаписи для специфической строки заголовка, оно, также применяется к заголовку <strong>Resent-</strong>, того же типа. Например, правило перезаписывающее “From:” также перезапишет “Resent-From:”.</li>
<li>Для локальных сообщений, если из ввода удалён “Sender:”, также удаляется  и “Resent-Sender:”.</li>
<li>Для локально переданных сообщений, если есть какая либо строка заголовка <strong>Resent-</strong>, но нет “Resent-Date:”, “Resent-From:” или “Resent-Message-Id:”, они добавляются по мере необходимости. Это - содержимое “Resent-Message-Id:” (а не “Message-Id:”), которое включается в строки логов в этом случае.</li>
<li>Логика для добавления “Sender:” - дублируется для “Resent-Sender:”, когда присутствует любой заголовок <strong>Resent-</strong>.</li>
</ul>
</div>
<div class="section" id="auto-submitted">
<span id="ch44-06"></span><h2>Строка заголовка “Auto-Submitted:”<a class="headerlink" href="#auto-submitted" title="Ссылка на этот заголовок">¶</a></h2>
<p>Каждый раз, когда Exim создает автоответ, рикошет, или предупреждающее сообщение о задержке, он включает строку заголовка:</p>
<div class="highlight-python"><pre>Auto-Submitted: auto-replied</pre>
</div>
</div>
<div class="section" id="bcc">
<span id="ch44-07"></span><h2>Строка заголовка “Bcc:”<a class="headerlink" href="#bcc" title="Ссылка на этот заголовок">¶</a></h2>
<p>Если Exim вызывается с параметром <strong>-t</strong>, чтобы получить адреса получателей из заголовков сообщений, он удаляет любые строки заголовков “Bcc:” которые могут существовать (после извлечения их адресов). Если <strong>-t</strong> не представлена в командной строке, любые существующие “Bcc:” не удаляются.</p>
</div>
<div class="section" id="date">
<span id="ch44-08"></span><h2>Строка заголовка “Date:”<a class="headerlink" href="#date" title="Ссылка на этот заголовок">¶</a></h2>
<p>Если порожденное локально сообщение, или сообщение в режиме передачи, не имеет заголовка “Date:”, Exim добавляет один, используя текущую дату и время, если не была определен параметр <strong>suppress_local_fixups</strong>.</p>
</div>
<div class="section" id="delivery-date">
<span id="ch44-09"></span><h2>Строка заголовка “Delivery-date:”<a class="headerlink" href="#delivery-date" title="Ссылка на этот заголовок">¶</a></h2>
<p>Заголовок “Delivery-date:” - не часть стандартного набора заголовков <span class="target" id="index-4"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2822.html"><strong>RFC 2822</strong></a>. Exim может быть сконфигурирован для её добавления при финальной доставке сообщений. (Смотрите общий транспортный параметр <strong>delivery_date_add</strong>.) Он не должен присутствовать во время пути сообщения. Если установлена конфигурационный параметр <strong>delivery_date_add</strong> (по умолчанию), Exim удаляет заголовки “Delivery-date:” из входящих сообщений.</p>
</div>
<div class="section" id="envelope-to">
<span id="ch44-10"></span><h2>Строка заголовка “Envelope-to:”<a class="headerlink" href="#envelope-to" title="Ссылка на этот заголовок">¶</a></h2>
<p>Заголовок “Envelope-to:” - не часть стандартного набора заголовков <span class="target" id="index-5"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2822.html"><strong>RFC 2822</strong></a>. Exim может быть сконфигурирован для её добавления при финальной доставке сообщений. (Смотрите общий транспортный параметр <strong>envelope_to_add</strong>.) Он не должен присутствовать во время пути сообщения. Если установлен конфигурационный параметр <strong>envelope_to_add</strong> (по умолчанию), Exim удаляет заголовки “Envelope-to:” из входящих сообщений.</p>
</div>
<div class="section" id="from">
<span id="ch44-11"></span><h2>Строка заголовка “From:”<a class="headerlink" href="#from" title="Ссылка на этот заголовок">¶</a></h2>
<p>Если сообщение в режиме передачи не содержит строки заголовка “From:”, Exim добавляет её если истинно любое из следующих условий:
* Адрес отправителя конверта не пуст (т.е. это - не рикошет). Добавляемая строка заголовка копирует адрес отправителя конверта.
* Сессия SMTP аутентифицирована, и $authenticated_id - не пуст.</p>
<blockquote>
<div><ol class="arabic simple">
<li>Если нет домена, заданного управлением передачей, локальная часть - $authenticated_id, и домен - $qualify_domain.</li>
<li>Если непустой домен задан путём управления передачей, локальная часть - $authenticated_id, и домен - заданный домен.</li>
<li>Если управлением передачей задан пустой домен, предполагается, что в $authenticated_id - полный адрес.</li>
</ol>
</div></blockquote>
<p>Непустой отправитель конверта обладает приоритетом.</p>
<p>Если входящее, локально порожденное сообщение не содержит строки заголовка “From:”, и настройка <strong>suppress_local_fixups</strong> не задана, Exim добавляет заголовок содержащий адрес отправителя. Логин вызывающего пользователя и его полное имя используются для конструирования адреса, как описано в разделе <a class="reference internal" href="#ch44-18"><em>44.18</em></a>. Оно получаются из данных пароля, путём вызова <em>getpwuid()</em> (но, смотрите конфигурацию <strong>unknown_login</strong>). Адрес квалифицируется с <strong>qualify_domain</strong>.</p>
<p>Для совместимости с Sendmail, если приходящее не-SMTP сообщение содержит строку заголовка “From:”, содержащую лишь неквалифицированное имя вызывающего пользователя, она заменяется адресом, содержащим пользовательский логин и полное имя, как описано в разделе <a class="reference internal" href="#ch44-18"><em>44.18</em></a>.</p>
</div>
<div class="section" id="message-id">
<span id="ch44-12"></span><h2>Строка заголовка “Message-ID:”<a class="headerlink" href="#message-id" title="Ссылка на этот заголовок">¶</a></h2>
<p>Если порожденные локально сообщение, или сообщение в режиме передачи, не имеет заголовка “Message-ID:”, или “Resent-Message-ID:”, и не установлен параметр <strong>suppress_local_fixups</strong>, Exim добавляет подходящий заголовок в сообщение. Если в сообщении есть любой заголовок “Resent-:”, он создаёт “Resent-Message-ID:”. Идентификатор конструируется из внутреннего идентификатора сообщения Exim`a, с предшествующей буквой “E”, для гарантии, что он всегда начинается с буквы, и с и сопровождается &#8220;&#64;&#8221; и первичным именем хоста. Дополнительная информация может быть включена в эту строку заголовка, путём установки параметра <strong>message_id_header_text</strong> и/или <strong>message_id_header_domain</strong>.</p>
</div>
<div class="section" id="received">
<span id="ch44-13"></span><h2>Строка заголовка “Received:”<a class="headerlink" href="#received" title="Ссылка на этот заголовок">¶</a></h2>
<p>Строка заголовка “Received:” добавляется в начале каждого сообщения. Содержимое определяется путём конфигурационного параметра <strong>received_header_text</strong>, и Exim автоматически добавляет точку с запятой и штамп времени в сконфигурированную строку.</p>
<p>Заголовок “Received:” создается как только приходит строка заголовка сообщения. На этом этапе, метка времени в заголовке “Received:” - время начала приёма сообщения. Это значение - то, которое замечено ACL DATA и функцией <em>local_scan()</em>.</p>
<p>Как только сообщение принято, временная метка в заголовке “Received:” изменяется на время приёма, которое является (кроме маленькой задержки на запись “-H” файла в спуле) наименьшим временем, когда могла начаться доставка.</p>
</div>
<div class="section" id="references">
<span id="ch44-14"></span><h2>Строка заголовка “References:”<a class="headerlink" href="#references" title="Ссылка на этот заголовок">¶</a></h2>
<p>Сообщения созданные транспортом <strong>autoreply</strong> включают заголовок “References:”. Он создаётся   согласно правилам, которые описаны в <span class="target" id="index-6"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2822.html#3.64"><strong>RFC 2822</strong></a> (которая заявляет, что ответы должны содержать такую строку заголовка), <span class="target" id="index-7"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc3834.html#3.14"><strong>RFC 3834</strong></a> (которая заявляет, что автоматические ответы не различаются в этом отношении). Однако, поскольку некоторый программное обеспечение обрабатывающее почту, не очень хорошо справляется с очень длинными строками заголовков, не более чем 12 идентификаторов сообщений копируются из строки заголовка “References:”, входящего сообщения. Если их больше 12-ти, копируются первый, и последующие 11, до добавления идентификатора сообщения для входящего сообщения.</p>
</div>
<div class="section" id="return-path">
<span id="ch44-15"></span><h2>Строка заголовка “Return-path:”<a class="headerlink" href="#return-path" title="Ссылка на этот заголовок">¶</a></h2>
<p>Заголовок “Return-path:” задан как нечто, что MTA может вставить, когда производит финальную доставку сообщения. (Смотрите общий транспортный параметр <strong>return_path_add</strong>.) Поэтому, они не должны быть в сообщениях, которые находятся в пути. Если установлена конфигурационный параметр <strong>return_path_remove</strong> (по умолчанию - установлен), Exim удаляет заголовки “Return-path:” из входящих сообщений.</p>
</div>
<div class="section" id="sender">
<span id="ch44-16"></span><h2>Строка заголовка “Sender:”<a class="headerlink" href="#sender" title="Ссылка на этот заголовок">¶</a></h2>
<p>Для локально порожденных сообщений от недоверенных пользователей, Exim может удалять существующий заголовок “Sender:”, и может добавлять новый. Вы можете изменять эти действия, путём установки параметр <strong>local_sender_retain</strong> в истину, <strong>local_from_check</strong> - в ложь, или используя установку <strong>suppress_local_fixups</strong>.</p>
<p>Когда локальное сообщение принимается от недоверенного пользователя, и <strong>local_from_check</strong> - истинна (по умолчанию), и не установлена <strong>suppress_local_fixups</strong>, производиться проверка, что адрес данный в заголовке “From:” - корректный (локальный) отправитель сообщения. Ожидаемый адрес, имеет логин пользователя как локальную часть, и значение <strong>qualify_domain</strong> - как доменную. Преффиксы и суффиксы для локальных частей могут быть разрешены путём установки <strong>local_from_prefix</strong> и <strong>local_from_suffix</strong>, соответственно. Если “From:” не содержит корректного отправителя, к сообщению добавляется строка “Sender:”.</p>
<p>Если вы установите <strong>local_from_check</strong> в ложь, этой проверки не произойдёт. Однако, всё ещё происходит удаление существующей строки “Sender:”, если вы не установили в истину <strong>local_sender_retain</strong>. Невозможно одновременно установить в истину эти два параметра.</p>
<p>По умолчанию, для сообщений полученных по TCP/IP не производиться обработки заголовка “Sender:”, или для сообщений посланных доверенными пользователями. Однако, когда сообщение посылается через TCP/IP в режиме передачи, и для управления передачей не задана <strong>sender_retain</strong>, происходит следующая обработка:</p>
<p>Вначале, удаляются любые существующие строки “Sender:”. Затем, если сессия SMTP аутентифицирована, и $authenticated_id непуста, адрес отправителя создаётся следующим образом:</p>
<ul class="simple">
<li>Если управлением передачей не задан домен, локальная часть - $authenticated_id, и домен - $qualify_domain.</li>
<li>Если настройками режима передачи задан непустой домен, локальная часть - $authenticated_id, и домен - заданный домен</li>
<li>Если настройками режима передачи задан пустой домен, $authenticated_id считается полным адресом.</li>
</ul>
<p>Этот адрес сравнивается с адресом в заголовке “From:”. Если они различны, добавляется строка “Sender:”, содержащая созданный адрес. Префиксы и суффиксы для локальной части в “From:” могут быть разрешены путём установки <strong>local_from_prefix</strong> и <strong>local_from_suffix</strong>, соответственно.</p>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last">Каждый раз, когда создаётся заголовок “Sender:”, путь возврата сообщения (адрес отправителя конверта) изменяется на тот же самый адрес, исключая случай в режиме передачи, когда задан параметр <strong>sender_retain</strong>.</p>
</div>
</div>
<div class="section" id="ch44-17">
<span id="id5"></span><h2>Добавление и удаление заголовков в маршрутизаторах и транспортах<a class="headerlink" href="#ch44-17" title="Ссылка на этот заголовок">¶</a></h2>
<p>Когда сообщение доставляется, дополнение и удаление строк заголовков может быть задано в системном фильтре, или любом маршрутизаторе и транспорте, который обрабатывает сообщение. Раздел <a class="reference internal" href="ch43.html#ch43-06"><em>43.6</em></a> содержит детали о модификации заголовков в системном фильтре. Строки заголовков, также могут быть добавлены в ACL, при получении сообщения (смотрите раздел <a class="reference internal" href="ch40.html#ch40-22"><em>40.22</em></a>).</p>
<p>В отличие от того, что происходит в системном фильтре, модификация заголовков заданная в маршрутизаторах и транспортах применяется лишь к специфическим адресам получателей, которые обрабатываются этими маршрутизаторами и транспортами. Эти изменения не актуальны, пока копия сообщения не транспортируется. Поэтому, они не применяются к базовым наборам заголовков, и они не применяются к значениям переменных, которые ссылаются на строки заголовков.</p>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last">В частности, это означает, что любые раскрытия в конфигурации транспорта не могут ссылаться на модифицированные строки заголовков, поскольку эти раскрытия происходят до реальной транспортировки сообщения.</p>
</div>
<p>Для обоих, маршрутизаторов и транспортов, результат раскрытия параметра <strong>headers_add</strong> должен быть одной или более строкой заголовков, в соответствии с <span class="target" id="index-8"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2822.html"><strong>RFC 2822</strong></a>, разделённых новой строкой (код - “n”). Например:</p>
<div class="highlight-python"><pre>headers_add = X-added-header: added by $primary_hostname\n\
              X-added-second: another added header line</pre>
</div>
<p>Exim не проверяет синтаксис этих добавляемых заголовков.</p>
<p>Результат раскрытия <strong>headers_remove</strong> должен состоять из списка имён заголовков разделённых двоеточиями. Это может запутывать, поскольку имена заголовков сами по себе завершаются двоеточием. В этом случае, двоеточие - разделитель списка, а не часть имени. Например:</p>
<div class="highlight-python"><pre>headers_remove = return-receipt-to:acknowledge-to</pre>
</div>
<p>Когда <strong>headers_add</strong> и <strong>headers_remove</strong> заданы в маршрутизаторе, их значения раскрываются во время маршрутизации, и, затем, ассоциируются с каждым адресом, который принимается маршрутизатором, и, также, с любым новым адресом который им создается. Если адрес передаётся через несколько маршрутизаторов, как результат перенаправления или подстановки синонима, изменения накапливаются.</p>
<p>Однако, это не применяется к нескольким маршрутизаторам, как результату использования параметра <strong>unseen</strong>. Любые модификации заголовков, заданные путём маршруризатора <strong>unseen</strong> или его предшественников, применяются лишь к доставке <strong>unseen</strong>.</p>
<p>Адреса, которые заканчиваются различными установками <strong>headers_add</strong> или <strong>headers_remove</strong>, не могут быть доставлены вместе в пакете, таким образом, транспорт всегда имеет дело с рядом адресов, которые имеют теже самые требования к обработке заголовков.</p>
<p>Транспортировка начинается с записи оригинального набора заголовков прибывшего с сообщением, возможно, модифицированного системным фильтром. При выписке этих строк, Exim консультируется со списком имён заголовков которые добавлены адресам получателей путём параметра <strong>headers_remove</strong> в маршрутизаторе, и, также консультируется с транспортным параметром <strong>headers_remove</strong>. Строки заголовков, чьи имена находятся в одном из этих списков - не выписываются. Если есть несколько любых перечисленных заголовков, все они пропускаются.</p>
<p>После записи оставшихся строк оригинальных заголовков, записываются новые строки заголовков, которые заданы параметром маршрутизаторов <strong>headers_add</strong>, в порядке как они были добавлены к адресам. Они сопровождаются любыми строками заголовков заданными транспортным параметром <strong>headers_add</strong>.</p>
<p>Этот способ обработки изменений строк заголовка в маршрутизаторах и транспортах имеет следующие последствия:</p>
<ul>
<li><p class="first">Оригинальный набор заголовков, возможно, модифицированных системным фильтром, остаётся “видимым”, в том смысле, что переменные $header_xxx продолжают на них ссылаться всё время.</p>
</li>
<li><p class="first">Строки заголовков, которые добавлены параметра <strong>headers_add</strong> маршрутизатора - недоступны посредством синтаксиса раскрытия $header_xxx в последующих маршрутизаторах или транспортах.</p>
</li>
<li><p class="first">Наоборот, строки заголовков которые определены на удаление путём <strong>headers_remove</strong> в маршрутизаторе, остаются видимы в последующих маршрутизаторах и транспортах.</p>
</li>
<li><p class="first">Заголовки добавленные к адресу путём <strong>headers_add</strong> в маршрутизаторе не могут быть удалены путём последующих маршрутизаторов или транспортов.</p>
</li>
<li><p class="first">Добавленные заголовки могут ссылаться на содержимое оригинальных заголовков, которые должны быть удалены, даже если он имеет то же самое имя как и добавляемый заголовок. Например:</p>
<div class="highlight-python"><pre>headers_remove = subject
headers_add = Subject: new subject (was: $h_subject:)</pre>
</div>
</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Предупреждение</p>
<p class="last">Параметры <strong>headers_add</strong> и <strong>headers_remove</strong> не могут использоваться в маршрутизаторе <strong>redirect</strong>, в котором установлен параметр <strong>one_time</strong>.</p>
</div>
</div>
<div class="section" id="ch44-18">
<span id="id6"></span><h2>Конструирование адресов<a class="headerlink" href="#ch44-18" title="Ссылка на этот заголовок">¶</a></h2>
<p>Когда Exim создаёт адрес отправителя для локально порожденных сообщений, он использует форму:</p>
<div class="highlight-python"><pre>&lt;user name&gt;  &lt;login@qualify_domain&gt;</pre>
</div>
<p>Например:</p>
<div class="highlight-python"><pre>Zaphod Beeblebrox &lt;zaphod@end.univ.example&gt;</pre>
</div>
<p>Имя пользователя получается из установки <strong>-F</strong> командной строки (если установлено), или, иначе, путём поиска вызвавшего пользователя <em>getpwuid()</em> и извлечения поля “gecos” из вхождения пароля. Если поле “gecos” содержит символ “&amp;”, он заменяется на логин с первой буквой в верхнем регистре, как обычно во множестве операционных систем. Смотрите параметр <strong>gecos_name</strong> для способа приспособить обработку поля “gecos”. Параметр <strong>unknown_username</strong> может использоваться для задания имени пользователя в случаях, когда в файле паролей нет вхождения.</p>
<p>Во всех случаях, имя пользователя должно соответствовать <span class="target" id="index-9"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2822.html"><strong>RFC 2822</strong></a> путём квотирования всего, или частей, по необходимости. Кроме того, если оно содержит любые непечатаемые символы, оно кодируется как описано в <span class="target" id="index-10"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2047.html"><strong>RFC 2047</strong></a>, определяющем способ включения не-ASCII символов в строки заголовков. Значение параметра <strong>headers_charset</strong> задаёт имя кодирования, которое используется (символы, как предполагается, в этой кодировке). Установка <strong>print_topbitchars</strong> контролирует, считать ли символы с установленным высшим битом (т.е., с кодами больше 127) как печатные символы, или нет.</p>
</div>
<div class="section" id="ch44-19">
<span id="id7"></span><h2>Регистры локальных частей<a class="headerlink" href="#ch44-19" title="Ссылка на этот заголовок">¶</a></h2>
<p><span class="target" id="index-11"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2822.html"><strong>RFC 2822</strong></a> устанавливает, что регистр букв в локальных частях не может предполагаться незначащим. Exim сохраняет регистр локальных частей адресов, но, по умолчанию, он использует форму в нижнем регистре, при маршрутизации, поскольку на большинстве UNIX-систем имена пользователей в нижнем регистре, и требуется нечувствительную к регистру маршрутизацию. Однако, любой специфический маршрутизатор можно заставить использовать оригинальный регистр для локальных частей, путём установки общего параметра маршрутизаторов <strong>caseful_local_part</strong>.</p>
<p>Если вам необходимо иметь имена пользователей в смешанном регистре на вашей системе, лучшим способом перейти, предполагая что вы хотите регистронезависимую обработку входящей почты, - установить ваш первый маршрутизатор на преобразование входящих локальных частей в ваших доменах в корректный регистр, путём поиска по файлу. Например:</p>
<div class="highlight-python"><pre>correct_case:
  driver = redirect
  domains = +local_domains
  data = ${lookup{$local_part}cdb\
                 {/etc/usercased.cdb}{$value}fail}\
                 @$domain</pre>
</div>
<p>Для этого маршрутизатора, локальная часть - приводится к нижнему регистру путём действия по умолчанию(<strong>caseful_local_part</strong> - не установлена). Локальная часть в нижнем регистре используется для поиска новой локальной части в корректном регистре. Тогда, если вы установите <strong>caseful_local_part</strong> в любом последующем маршрутизаторе, обрабатывающем ваши домены, то они будут оперировать локальными частями в корректном регистре, в регистрозависимой манере.</p>
</div>
<div class="section" id="ch44-20">
<span id="id8"></span><h2>Точки в локальных частях<a class="headerlink" href="#ch44-20" title="Ссылка на этот заголовок">¶</a></h2>
<p><span class="target" id="index-12"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2822.html"><strong>RFC 2822</strong></a> запрещает пустые компоненты в локальных частях. Таким образом, локальная часть не помещенная в кавычки не может начинаться или заканчиваться точкой, или иметь две точки подряд в середине. Однако, кажется, многие MTA не принуждают к этому, таким образом, Exim разрешает пустые компоненты для совместимости.</p>
</div>
<div class="section" id="ch44-21">
<span id="id9"></span><h2>Перезапись адресов<a class="headerlink" href="#ch44-21" title="Ссылка на этот заголовок">¶</a></h2>
<p>Перезапись адресов отправителей и получателей, и адресов в заголовках, может происходить автоматически, или как результат конфигурационных параметров, как описано в главе <a class="reference internal" href="ch31.html#ch31-00"><em>31</em></a>. Заголовки, которые могут быть этим затронуты - “Bcc:”, “Cc:”, “From:”, “Reply-To:”, “Sender:” и “To:”.</p>
<p>Автоматическая перезапись включает перезапись, как указано выше. Другой случай, в котором это может случиться - когда дан неполный нелокальный домен. Процесс маршрутизации может вызвать его раскрытие в полное доменное имя. Например, заголовок типа</p>
<div class="highlight-python"><pre>To: hare@teaparty</pre>
</div>
<p>мог быть перезаписан как</p>
<div class="highlight-python"><pre>To: hare@teaparty.wonderland.fict.example</pre>
</div>
<p>Перезапись как результат маршрутизации - один из видов обработки сообщений которые не происходят во время прихода сообщения, так как она не может быть сделана до маршрутизации адреса.</p>
<p>Строго, нельзя производить никакие доставки сообщения, пока все адреса не будут маршрутизированы, в случае, если любой заголовок был изменён в результате маршрутизации. Однако, выполнение этого, практически, задержало бы много доставок на чрезмерное время, лишь потому, что один адрес не мог быть немедленно маршрутизирован. Поэтому, Exim не задерживает другие доставки, когда задерживается маршрутизация одного или более адресов.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Содержание</a></h3>
  <ul>
<li><a class="reference internal" href="#">Обработка сообщения</a><ul>
<li><a class="reference internal" href="#ch44-01">Режим передачи для нелокальных сообщений</a></li>
<li><a class="reference internal" href="#ch44-02">Завершения строк</a></li>
<li><a class="reference internal" href="#ch44-03">Неквалифицированные адреса</a></li>
<li><a class="reference internal" href="#from-uucp">Строка “From” UUCP</a></li>
<li><a class="reference internal" href="#resent">Строки заголовков <strong>Resent-</strong></a></li>
<li><a class="reference internal" href="#auto-submitted">Строка заголовка “Auto-Submitted:”</a></li>
<li><a class="reference internal" href="#bcc">Строка заголовка “Bcc:”</a></li>
<li><a class="reference internal" href="#date">Строка заголовка “Date:”</a></li>
<li><a class="reference internal" href="#delivery-date">Строка заголовка “Delivery-date:”</a></li>
<li><a class="reference internal" href="#envelope-to">Строка заголовка “Envelope-to:”</a></li>
<li><a class="reference internal" href="#from">Строка заголовка “From:”</a></li>
<li><a class="reference internal" href="#message-id">Строка заголовка “Message-ID:”</a></li>
<li><a class="reference internal" href="#received">Строка заголовка “Received:”</a></li>
<li><a class="reference internal" href="#references">Строка заголовка “References:”</a></li>
<li><a class="reference internal" href="#return-path">Строка заголовка “Return-path:”</a></li>
<li><a class="reference internal" href="#sender">Строка заголовка “Sender:”</a></li>
<li><a class="reference internal" href="#ch44-17">Добавление и удаление заголовков в маршрутизаторах и транспортах</a></li>
<li><a class="reference internal" href="#ch44-18">Конструирование адресов</a></li>
<li><a class="reference internal" href="#ch44-19">Регистры локальных частей</a></li>
<li><a class="reference internal" href="#ch44-20">Точки в локальных частях</a></li>
<li><a class="reference internal" href="#ch44-21">Перезапись адресов</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="ch43.html" title="предыдущая глава">Системная фильтрация сообщений</a></li>
      <li>Next: <a href="ch45.html" title="следующая глава">Обработка SMTP</a></li>
  </ul></li>
</ul>
  <h3>На этой странице</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/ch44.txt"
           rel="nofollow">Показать исходный текст</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Быстрый поиск</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Искать" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Введите слова для поиска или имя модуля, класса или функции.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy; Copyright 2011, Exim Maintainers.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
    </div>
  </body>
</html>
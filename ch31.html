
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Перезапись адресов &mdash; Specification of the Exim Mail Transfer Agent 4.70 documentation</title>
    
    <link rel="stylesheet" href="static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '4.70',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/underscore.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <script type="text/javascript" src="static/translations.js"></script>
    <link rel="top" title="Specification of the Exim Mail Transfer Agent 4.70 documentation" href="index.html" />
    <link rel="next" title="Конфигурация повторов" href="ch32.html" />
    <link rel="prev" title="Транспорт smtp" href="ch30.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="static/small_flask.css" type= "text/css" rel="stylesheet" />

  </head>
  <body>
    <div class="related">
      <h3>Просмотр</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="Словарь-указатель"
             accesskey="I">словарь</a></li>
        <li class="right" >
          <a href="ch32.html" title="Конфигурация повторов"
             accesskey="N">следующий</a> |</li>
        <li class="right" >
          <a href="ch30.html" title="Транспорт smtp"
             accesskey="P">предыдущий</a> |</li>
        <li><a href="index.html">Specification of the Exim Mail Transfer Agent 4.70 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="ch31-00">
<span id="id1"></span><h1>Перезапись адресов<a class="headerlink" href="#ch31-00" title="Ссылка на этот заголовок">¶</a></h1>
<p>Существуют некоторые обстоятельства, при которых Exim автоматически переписывает домены в адресах. Два самых частых - когда адрес даётся без домена (называемый  “неквалифицированным адресом” (“unqualified address”)), или когда адрес содержит сокращённый домен, раскрываемый путём поиска в DNS.</p>
<p>Дисквалифицированные адреса конверта принимаются лишь для локально переданных сообщений, или для сообщений, которые передаются с хостов, совпадающих с <strong>sender_unqualified_hosts</strong> или <strong>recipient_unqualified_hosts</strong>, соответственно. Неполные адреса, в строках заголовков, квалифицируются, если они в локально переданных сообщениях, или сообщениях с хостов, которым разрешено посылать неквалифицированные адреса конверта. Иначе, неквалифицированные адреса в строках заголовков, ни квалифицированы, ни перезаписаны.</p>
<p>Одна ситуция, в которой Exim автоматически не перезаписывает домен, - когда его имя - CNAME запись в DNS. Старые RFC предлагают что такой домен домен должен быть перезаписан используя “каноническое” имя, и некоторые MTA так и делают. Новые RFC не содержат этого предложения.</p>
<div class="section" id="ch31-01">
<span id="id2"></span><h2>Явно сконфигурированная перезапись адресов<a class="headerlink" href="#ch31-01" title="Ссылка на этот заголовок">¶</a></h2>
<p>Эта часть описывает правила перезаписи, которые могут быть использованы в основном разделе конфигурационного файла, и, также, в общего параметра <strong>headers_rewrite</strong>, которая может быть установлена лишь для транспорта.</p>
<p>Некоторые люди полагают, что сконфигурированная перезапись адресов - Смертный Грех. Другие полагают, что жизнь без этого - невозможна. Exim предоставляет средство; Вы не должны его использовать.</p>
<p>Главные правила перезаписи, заданные в секции <strong>rewrite</strong> главного конфигурационного файла, применяются к адресам в заголовках и конвертах входящих сообщений. В каждом правиле определяется тип обрабатываемых адресов.</p>
<p>Будет перезаписан или нет, адрес в строках заголовка, зависит от происхождения заголовков и типа перезаписи. Глобальная перезапись, т.е. правила перезаписи из <strong>rewrite</strong> секции, применяются только к тем заголовкам, которые были получены вместе с сообщением.</p>
<p>Главные правила перезаписи, в строках заголовков, применяются лишь к тем заголовкам, которые были получены с сообщением, и, в случае транспортной перезаписи, тем, которые были добавлены системным фильтром. Таким образом, это применяется лишь к тем заголовкам, которые являются общими для всех копий сообщения. Строки заголовков, которые добавлены путём индивидуальных маршрутизаторов или транспортов (и, которые поэтому являются специфическими для индивидуальных получателей адресов), не перезаписываются глобальными правилами.</p>
<p>Перезаписи во время транспортировки (параметр <strong>headers_rewrite</strong>) подвергаются все заголовки, кроме добавленных маршрутизаторами и транспортами. Этому подвергаются заголовки добавленые ACL или системным фильтром, также как и заголовки полученные вместе с сообщением.</p>
<p>Вообще, перезапись адресов от вашей системы или домена имеет немного легитимности (законности). Перезапись иных адресов должна быть сделана лишь с большой осторожностью и в особых обстоятельствах. Автор Exim`a полагает, что перезапись должна использоваться расчётливо, и, главным образом, для “упорядочивания” адресов в ваших собственных доменах. Хотя это и может использоваться как инструмент маршрутизации, это очень строго нерекомендуется.</p>
<p>Есть два часто встречающихся обстоятельства, где используется перезапись, как иллюстрировано этими примерами:</p>
<ul class="simple">
<li>Компания, чей домен - “hitch.fict.example”, имеет множество хостов, которые обмениваются почтой друг с другом за файрволлом, но есть лишь один шлюз во внешний мир. Шлюз переписывает “*.hitch.fict.example” как “hitch.fict.example”, когда посылает почту наружу.</li>
<li>Хост перезаписывает локальные части собственных пользователей так, чтобы, например, “<a class="reference external" href="mailto:fp42&#37;&#52;&#48;hitch&#46;fict&#46;example">fp42<span>&#64;</span>hitch<span>&#46;</span>fict<span>&#46;</span>example</a>” стал “<a class="reference external" href="mailto:Ford&#46;Prefect&#37;&#52;&#48;hitch&#46;fict&#46;example">Ford<span>&#46;</span>Prefect<span>&#64;</span>hitch<span>&#46;</span>fict<span>&#46;</span>example</a>”.</li>
</ul>
</div>
<div class="section" id="ch31-02">
<span id="id3"></span><h2>Когда происходит перезапись?<a class="headerlink" href="#ch31-02" title="Ссылка на этот заголовок">¶</a></h2>
<p>Конфигурирование перезаписи адресов может иметь место на нескольких различных стадиях обработки сообщения</p>
<p>В начале ACL для MAIL, отправитель адреса может быть перезаписан путём специального SMTP правила перезаписи (смотрите раздел <a class="reference internal" href="#ch31-09"><em>31.9</em></a>), но никаких обычных правил перезаписи не применяется. Однако, если адрес отправителя проверен в ACL, и если он был перезаписан перед проверкой, то он остаётся перезаписанным и после неё. Последующее значение $sender_address - перезаписанный адрес. Также, это применяется если проверка отправителя происходит в RCPT ACL. Иначе, когда адрес отправителя не проверен, он перезаписывается сразу после получения строк заголовка.</p>
<p>Точно также, в начале ACL для RCPT, текущий адрес получателя может быть перезаписан, во время SMTP, путём специального правила, но никаких обычных правил перезаписи не применяется. Однако, когда проверяется получатель, поведение отличается от проверки адреса отправителя. Адрес перезаписывается для проверки, но на этой стадии перезапись не запоминается. Значение $local_part и $domain, после проверки, всегда те же самые, что и до неё (т.е. они содержат не перезаписанный - исключая перезапись во время SMTP - адрес).</p>
<p>Как только строки заголовков были получены, все адреса получателей конверта перезаписаны насовсем, и, также, перезапись применяется к адресам в строках заголовков (если сконфигурировано). Это происходит до добавления любых строк заголовков, которые были заданы в MAIL или RCPT ACL, и до DATA ACL и выполнения функции <em>local_scan()</em>.</p>
<p>Когда адрес маршрутизируется, или для доставки, или для проверки, к дочерним адресам, созданный перенаправлением, перезапись применяется немедленно, если на маршрутизаторе не установлен параметр <strong>no_rewrite</strong>.</p>
<p>В транспортное время, дополнительная перезапись адресов в строках заголовков может быть задана путём установки в транспорте общим параметром <strong>headers_rewrite</strong>. Этот параметря содержит правила, которые идентичны по форме правилам в секции перезаписи, конфигурационного файла. Они применяются к оригинальным строкам заголовков, и любым добавленным ACL или системным фильтром. Они не применяются к строкам заголовков которые были добавлены маршрутизаторами или транспортами.</p>
<p>Исходящий отправитель конверта может быть перезаписан при помощи транспортного параметра <strong>return_path</strong>. Однако, невозможно переписать получателей получателей конверта в транспортное время.</p>
</div>
<div class="section" id="ch31-03">
<span id="id4"></span><h2>Тестирование правил перезаписи применяемых на входе<a class="headerlink" href="#ch31-03" title="Ссылка на этот заголовок">¶</a></h2>
<p>Входная конфигурация перезаписи появляется в части рабочего конфигурационного файла, озаглавленная как “begin rewrite”. Она может быть протестирована путём параметра командной строки <strong>-brw</strong>. Она берёт адрес (который может быть полным адресом, в соответствии с <span class="target" id="index-0"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2822.html"><strong>RFC 2822</strong></a>) как аргумент. Вывод - список как адрес был бы преобразован путём правил перезаписи для каждого различного места, в котором он мог бы появиться во входящем сообщении, т.е. для каждого различного заголовка, и для поля отправителя конверта, и поля получателя конверта. Например,</p>
<div class="highlight-python"><pre>exim -brw ph10@exim.workshop.example</pre>
</div>
<p>может привести к такому выводу</p>
<div class="highlight-python"><pre>sender: Philip.Hazel@exim.workshop.example
from: Philip.Hazel@exim.workshop.example
to: ph10@exim.workshop.example
cc: ph10@exim.workshop.example
bcc: ph10@exim.workshop.example
reply-to: Philip.Hazel@exim.workshop.example
env-from: Philip.Hazel@exim.workshop.example
env-to: ph10@exim.workshop.example</pre>
</div>
<p>который показывает, что перезапись была установлена для этого адреса, когда он используется в любых исходных полях, но не когда он появляется как адрес получателя. В настоящее время, нет никакого альтернативного способа протестировать правила перезаписи установленные для специфического транспорта.</p>
</div>
<div class="section" id="ch31-04">
<span id="id5"></span><h2>Правила перезаписи<a class="headerlink" href="#ch31-04" title="Ссылка на этот заголовок">¶</a></h2>
<p>Секция перезаписи, в конфигурационном файле, содержит строки правил перезаписи, в форме:</p>
<div class="highlight-python"><pre>“&lt;source pattern&gt;  &lt;replacement&gt;  &lt;flags&gt;”</pre>
</div>
<p>Правила перезаписи, которые заданы для общей транспортного параметра <strong>headers_rewrite</strong>, даны в в виде списка, разделённого двоеточиями. Каждый элемент в списке принимает такую же форму, как строка в главной конфигурации перезаписи (исключая, разумеется, что любые двоеточия должны быть удвоены).</p>
<p>Формат исходных шаблонов, и строк замены описаны ниже. Каждый - завершается пустым пространством (пробелом), если он не находится в двойных кавычках, в этом случае, применяются обычные соглашения о квотировании <a class="footnote-reference" href="#id16" id="id6">[1]</a>. Флаги - единственные символы, которые могут появляться в любом порядке. Пробелы и символы табуляции, между ними, игнорируются.</p>
<p>Для каждого адреса, который, потенциально, может быть перезаписан, правила сканируются по порядку, и замены для адресов из ранних правил, могут быть самостоятельно заменены более поздними правилами (но, смотрите флаги “q” и “R”).</p>
<p>Порядок в котором перезаписываются адреса - не задан, может измениться между версиями, и на него нельзя положиться, с одним исключением: когда сообщение получено, отправитель конверта всегда перезаписан первым, до перезаписи любых строк заголовков. Например, строка замены, для перезаписи адреса в “To:”, не должна предполагать, что адрес сообщения в “From:” был (или небыл) уже перезаписан. Однако, перезапись “From:” может предположить, что отправитель конверта уже был перезаписан.</p>
<p>Переменные $local_part и $domain могут быть использованы в строке замены, для ссылки на перезаписываемый адрес. Отметьте, что управляемая поиском перезапись не может быть сделана правилом в форме</p>
<div class="highlight-python"><pre>*@*   ${lookup ...</pre>
</div>
<p>где ключ поиска использует $1 и $2, или $local_part и $domain для ссылки на перезаписываемый адрес.</p>
</div>
<div class="section" id="ch31-05">
<span id="id7"></span><h2>Шаблоны перезаписи<a class="headerlink" href="#ch31-05" title="Ссылка на этот заголовок">¶</a></h2>
<p>Исходные шаблоны в правилах перезаписи - это любой элемент, который может появиться в списке адресов (смотрите раздел <a class="reference internal" href="ch10.html#ch10-19"><em>10.19</em></a>). Фактически, он обрабатывается как одноэлементный список адресов, что означает, что он раскрывается до проверки адресов. Как всегда, если в шаблоне вы используете регулярное выражение, вы должны позаботиться о экранировке символов доллара и обратного слэша, или использовать средство <tt class="docutils literal"><span class="pre">\N</span></tt>, для подавления раскрытия строки в пределах регулярного выражения.</p>
<p>Домены, в шаблонах <a class="footnote-reference" href="#id17" id="id8">[2]</a>, должны быть даны в строчных (маленьких) буквах. Локальные части, в шаблонах, чувствительны к регистру. Если вы хотите сделать регистронезависисимое сравнение локальных частей, вы должны использовать регулярное выражение начинающееся с <tt class="docutils literal"><span class="pre">^(?i)</span></tt>.</p>
<p>После совпадения, числовые переменные $1, $2 и т.д., могут быть установлены, в зависимости от произошедшего типа соответствия. Это может использоваться в строках замены, для вставления части входящего адреса. $0 - всегда совпадает с полным входящим адресом. Когда используется регулярное выражение, числовые переменные установлены из его подвыражений. Для других типов шаблонов, они устанавливаются следующим образом:</p>
<ul>
<li><p class="first">Если локальная часть, или домен, начинаются со звёздочки, числовые переменные ссылаются на строки символов, совпадающие со звёздочками, с $1 - ассоциированной с первой звёздочкой, $2 - со второй, если она представлена. Например, шаблон</p>
<div class="highlight-python"><pre>*queen@*.fict.example</pre>
</div>
<p>сравнивается с адресом “<a class="reference external" href="mailto:hearts-queen&#37;&#52;&#48;wonderland&#46;fict&#46;example">hearts-queen<span>&#64;</span>wonderland<span>&#46;</span>fict<span>&#46;</span>example</a>”, тогда</p>
<div class="highlight-python"><pre>$0 = hearts-queen@wonderland.fict.example
$1 = hearts-
$2 = wonderland</pre>
</div>
<p>Отметьте, что если локальная часть не начинается со звёздочки, но домен начинается, тогда $1 будет содержать совпавшую часть домена.</p>
</li>
<li><p class="first">Если доменная часть шаблона - частичный поиск, совпавшие и фиксированные части домена помещаются в следующие доступные числовые переменные. Предположим, например, что адрес “<a class="reference external" href="mailto:foo&#37;&#52;&#48;bar&#46;baz&#46;example">foo<span>&#64;</span>bar<span>&#46;</span>baz<span>&#46;</span>example</a>” - обрабатывается по правилу перезаписи в форме</p>
<div class="highlight-python"><pre>*@partial-dbm;/some/dbm/file    &lt;replacement string&gt;</pre>
</div>
<p>и ключ в файле, соответствует домену в форме “*.baz.example”. Тогда</p>
<div class="highlight-python"><pre>$1 = foo
$2 = bar
$3 = baz.example</pre>
</div>
<p>Если адрес “<a class="reference external" href="mailto:foo&#37;&#52;&#48;bar&#46;baz&#46;example">foo<span>&#64;</span>bar<span>&#46;</span>baz<span>&#46;</span>example</a>” находится, он совпадает с тем же вхождением постановочного знака, и в случае $2 - устанавливается в пустую строку, но $3 всё ещё совпадает с “baz.example”. Если не подставочный ключ совпадает с частичным поиском, $2 снова устанавливается в пустую строку, и $3 устанавливается в весь домен. Для не частичных поисков поисков домена, никакие числовые переменные не заданы.</p>
</li>
</ul>
</div>
<div class="section" id="ch31-06">
<span id="id9"></span><h2>Перезапись замен<a class="headerlink" href="#ch31-06" title="Ссылка на этот заголовок">¶</a></h2>
<p>Если строка замены для правила - единственная звёздочка, адрес, который совпадает с шаблоном, и флаги не перезаписываются, и никакие последующие правила перезаписи не просматриваются. Например,</p>
<div class="highlight-python"><pre>hatta@lookingglass.fict.example  *  f</pre>
</div>
<p>определяет, что “<a class="reference external" href="mailto:hatta&#37;&#52;&#48;lookingglass&#46;fict&#46;example">hatta<span>&#64;</span>lookingglass<span>&#46;</span>fict<span>&#46;</span>example</a>” - никогда не будет перезаписан в заголовках “From:”.</p>
<p>Если заменяющая строка - не единственная звёздочка, она раскрывается, и должна привести к полностью квалифицированному адресу <a class="footnote-reference" href="#id18" id="id10">[3]</a>. В пределах раскрытия, переменные $local_part и $domain ссылаются на перезаписываемый адрес. Любые буквы, которые они содержат, сохраняют их оригинальный регистр, - они не преобразуются в нижний регистр. Числовые переменные установлены согласно типу шаблона, совпадающего с адресом, как описано выше. Если раскрытие принудительно неудачно, путём присутствия “fail” в условном элементе, или элементе поиска, перезапись путём текущего правила оставлена, но последующие правила могут вступить в силу. Любые другие ошибки раскрытия вызывают пропуск всей операции перезаписи, и вход пишется в лог паники.</p>
</div>
<div class="section" id="ch31-07">
<span id="id11"></span><h2>Флаги перезаписи<a class="headerlink" href="#ch31-07" title="Ссылка на этот заголовок">¶</a></h2>
<p>Есть три различных вида флагов, которые могут появляться в правилах перезаписи:</p>
<ul class="simple">
<li>Флаги, которые определяют, какой заголовок и адрес конверта перезаписывать: “E”, “F”, “T”, “b”, “c”, “f”, “h”, “r”, “s”, “t”.</li>
<li>Флаг, который определяет перезапись во время SMTP: “S”.</li>
<li>Флаги, которые контролируют процесс перезаписи: “Q”, “q”, “R”, “w”.</li>
</ul>
<p>Для правил являющихся частью общего транспортного параметр  <strong>headers_rewrite</strong>, “E”, “F”, “T” и “S” не разрешены.</p>
</div>
<div class="section" id="ch31-08">
<span id="id12"></span><h2>Флаги, определяющие какие заголовки и адреса конверта перезаписывать<a class="headerlink" href="#ch31-08" title="Ссылка на этот заголовок">¶</a></h2>
<p>Если нет ни одного из следующих флагов, ни флага “S” (смотрите раздел <a class="reference internal" href="#ch31-09"><em>31.9</em></a>), главное правило перезаписи применяется ко всем заголовкам, полям отправителя и получателя конверта, тогда как правило перезаписи в транспортное время, применяется лишь ко всем заголовкам. Иначе, правило перезаписи пропускается, если не обрабатываются релевантные адреса.</p>
<div class="highlight-python"><pre>E       все поля конверта
F       поле “From” в конверте
T       поле “To” в конверте
b       заголовок “Bcc:”
c       заголовок “Cc:”
f       заголовок “From:”
h       все заголовки
r       заголовок “Reply-To:”
s       заголовок “Sender:”
t       заголовок “To:”</pre>
</div>
<p>&#8220;Все заголовки&#8221; - означает все заголовки перечисленные выше, которые могут быть выбраны индивидуально, плюс их <em>Resent-</em> версии. Это не включает иные заголовки, типа <em>Subject:</em> и т.п.</p>
<p>Вам надо быть осторожным при перезаписи заголовков <em>Sender:</em>, и ограничить ее известными специальными случаями в ваших доменах.</p>
</div>
<div class="section" id="smtp">
<span id="ch31-09"></span><h2>Флаг перезаписи во время SMTP<a class="headerlink" href="#smtp" title="Ссылка на этот заголовок">¶</a></h2>
<p>Флаг перезаписи “S” определяет перезапись входящих адресов конверта во время SMTP, как только адрес получен в команде MAIL или RCPT, и до любых других процессов; даже до проверки синтаксиса. Шаблон обязан быть регулярным выражением, и он сравнивается с любыми данными для команд, включая любые соседние угловые скобки.</p>
<p>Форма правила перезаписи позволяет обработать адреса, которые не соответствуют <span class="target" id="index-1"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2821.html"><strong>RFC 2821</strong></a> и <span class="target" id="index-2"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2822.html"><strong>RFC 2822</strong></a> (например, адреса с восклицательными знаками, в пакетном SMTP-вводе). Поскольку ввод не обязан быть синтаксически правильным адресом, переменные $local_part и $domain недоступны в процессе раскрытия строки. Результат перезаписи замещает оригинальный адрес в командах MAIL и RCPT.</p>
</div>
<div class="section" id="ch31-10">
<span id="id13"></span><h2>Флаги контролирующие процесс перезаписи<a class="headerlink" href="#ch31-10" title="Ссылка на этот заголовок">¶</a></h2>
<p>Есть четыре флага, которые контролируют работу процесса перезаписи. Они вступают в силу лишь когда правило вызвано, т.е. когда адрес корректного типа (совпадает с флагами), и соответствуют шаблону:</p>
<ul>
<li><p class="first">Если в правиле установлен флаг “Q”, перезаписанному адресу разрешается быть неквалифицированной локальной частью. Она квалифицируется с <strong>qualify_recipient</strong>. В отсутствии “Q” перезаписанный адрес всегда должен включать домен.</p>
</li>
<li><p class="first">Если в правиле установлен флаг “q”, никакие дальнейшие правила перезаписи не рассматриваются, даже если не было фактической перезаписи, поскольку в раскрытии присутствовало “fail”.  Флаг “q” неэффективен, если адрес неверного типа (не соответствует флагам), или не совпадает с шаблоном.</p>
</li>
<li><p class="first">Флаг “R” вызывает повторное применение успешного правила перезаписи к новому адресу, до десяти раз. Это может быть скомбинировано с флагом “q”, для прекращения перезаписи как только будет несоответствие (после по крайней мере одной успешной перезаписи).</p>
</li>
<li><p class="first">Когда адрес в заголовке перезаписан, перезапись, обычно, применяется лишь к рабочей части адреса, с оставленными неизменными любыми комментариями и фразой <span class="target" id="index-3"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2822.html"><strong>RFC 2822</strong></a>. Например, перезапись может изменить</p>
<div class="highlight-python"><pre>From: Ford Prefect &lt;fp42@restaurant.hitch.fict.example&gt;</pre>
</div>
<p>на</p>
<div class="highlight-python"><pre>From: Ford Prefect &lt;prefectf@hitch.fict.example&gt;</pre>
</div>
<p>Иногда, есть потребность изменить весь элемент адреса, и это может быть сделано путём добавления флага “w” к правилу. Если он установлен для правила, вызывающего перезапись адреса в строке заголовка, заменяется весь адрес, а не только рабочая часть. Замена должна быть полным адресом согласно <span class="target" id="index-4"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2822.html"><strong>RFC 2822</strong></a>, включая угловые скобки, если есть необходимость. Если текст вне угловых скобок, содержит символ чьё значение более 126 или менее 32 (исключая табуляцию), текст кодируется согласно <span class="target" id="index-5"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2047.html"><strong>RFC 2047</strong></a>. Кодировка берётся из <strong>headers_charset</strong>, значение по умолчанию которой - ISO-8859-1.</p>
<p>Когда флаг “w” установлен для правила перезаписи адреса конверта, отбрасывается всё, кроме рабочей части.</p>
</li>
</ul>
</div>
<div class="section" id="ch31-11">
<span id="id14"></span><h2>Примеры перезаписи<a class="headerlink" href="#ch31-11" title="Ссылка на этот заголовок">¶</a></h2>
<p>Вот - пример двух обычных образцов перезаписи:</p>
<div class="highlight-python"><pre>*@*.hitch.fict.example  $1@hitch.fict.example
*@hitch.fict.example    ${lookup{$1}dbm{/etc/realnames}\
                   {$value}fail}@hitch.fict.example bctfrF</pre>
</div>
<p>Отметьте, что использование “fail” в поиске, во втором правиле, вызывает принудительную неудачу, в случае безуспешного поиска. В этом контексте, это имеет эффект оставления оригинального адреса неизменным, но Exim продолжает рассмотрение последующих правил, если таковые имеются, поскольку в этом правиле не присутстсвует флаг “q”. Альтернативой для “fail”, могла бы быть явная вставка $1, которая вызвала бы перезапись адреса прежним, за счёт маленького бита обработки. Не предоставление любого из них - ошибка, так как перезаписанный адрес не вообще содержал бы локальной части.</p>
<p>Первый пример, выше, заменяет домен вышестоящим, более общим доменом. Возможно, это нежелательно для некоторых локальных частей. Если правило</p>
<div class="highlight-python"><pre>root@*.hitch.fict.example  *</pre>
</div>
<p>было вставлено до первого правила, перезапись будет подавлена для локальной части “root” в любом домене, заканчивающемся на “hitch.fict.example”.</p>
<p>Перезапись может быть сделана условной, в ряде тестов, путём использования “${if” в элементе раскрытия. Например, для применения правил перезаписи лишь для сообщений, который созданы вне локального хоста:</p>
<div class="highlight-python"><pre>*@*.hitch.fict.example  "${if !eq {$sender_host_address}{}\
                        {$1@hitch.fict.example}fail}"</pre>
</div>
<p>Строка замены, в этом примере, помещена в кавычки, поскольку она содержит пустое пространство.</p>
<p>Exim не обрабатывает адреса в форме “адресов с восклицательными знаками” <a class="footnote-reference" href="#id19" id="id15">[4]</a>. Если он видит такой адрес, он обрабатывает его как неквалифицированную локальную часть, которую он квалифицирует с локальным квалификационным доменом (если источник сообщения локальный, или если удалённому хосту разрешается посылать неквалифицированные адреса). Перезапись может, иногда, использоваться для обработки простых адресов с восклицательным знаком, с фиксированным числом компонентов. Например, правило</p>
<div class="highlight-python"><pre>\N^([^!]+)!(.*)@your.domain.example$\N   $2@$1</pre>
</div>
<p>перезаписывает двухкомпонентный адрес с восклицательным знаком “host.name!user”, как доменный адрес “<a class="reference external" href="mailto:user&#37;&#52;&#48;host&#46;name">user<span>&#64;</span>host<span>&#46;</span>name</a>”. Однако, тут замешана безопасность, в использовании этого как глобального перезаписывающего правила, для адресов конверта. Это может предоставить чёрный ход для использования вашей системы как релея, поскольку входящие адреса кажутся локальными. Если адреса с восклицательными знаками получены через SMTP, более безопасно использовать флаг “S”, для их перезаписи при получении, так, чтобы проверка доставки могла быть сделана на перезаписанных адресах.</p>
<table class="docutils footnote" frame="void" id="id16" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[1]</a></td><td>помещении в двойные кавычки, экранировке - прим. lissyara</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id17" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[2]</a></td><td>шаблонах, или образцах - прим. lissyara</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id18" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id10">[3]</a></td><td>с доменной частью - прим. lissyara</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id19" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id15">[4]</a></td><td>“bang paths” - хрен его знает что это. - прим. lissyara</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Содержание</a></h3>
  <ul>
<li><a class="reference internal" href="#">Перезапись адресов</a><ul>
<li><a class="reference internal" href="#ch31-01">Явно сконфигурированная перезапись адресов</a></li>
<li><a class="reference internal" href="#ch31-02">Когда происходит перезапись?</a></li>
<li><a class="reference internal" href="#ch31-03">Тестирование правил перезаписи применяемых на входе</a></li>
<li><a class="reference internal" href="#ch31-04">Правила перезаписи</a></li>
<li><a class="reference internal" href="#ch31-05">Шаблоны перезаписи</a></li>
<li><a class="reference internal" href="#ch31-06">Перезапись замен</a></li>
<li><a class="reference internal" href="#ch31-07">Флаги перезаписи</a></li>
<li><a class="reference internal" href="#ch31-08">Флаги, определяющие какие заголовки и адреса конверта перезаписывать</a></li>
<li><a class="reference internal" href="#smtp">Флаг перезаписи во время SMTP</a></li>
<li><a class="reference internal" href="#ch31-10">Флаги контролирующие процесс перезаписи</a></li>
<li><a class="reference internal" href="#ch31-11">Примеры перезаписи</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="ch30.html" title="предыдущая глава">Транспорт <strong>smtp</strong></a></li>
      <li>Next: <a href="ch32.html" title="следующая глава">Конфигурация повторов</a></li>
  </ul></li>
</ul>
  <h3>На этой странице</h3>
  <ul class="this-page-menu">
    <li><a href="sources/ch31.txt"
           rel="nofollow">Показать исходный текст</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Быстрый поиск</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Искать" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Введите слова для поиска или имя модуля, класса или функции.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy; Copyright 2011, Exim Maintainers.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
    </div>
  </body>
</html>
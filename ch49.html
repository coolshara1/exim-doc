
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Файлы логов &mdash; Specification of the Exim Mail Transfer Agent 4.70 documentation</title>
    
    <link rel="stylesheet" href="_static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '4.70',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <link rel="top" title="Specification of the Exim Mail Transfer Agent 4.70 documentation" href="index.html" />
    <link rel="next" title="Утилиты Exim’a" href="ch50.html" />
    <link rel="prev" title="Использование Exim’a как клиента без очереди сообщений" href="ch48.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="_static/small_flask.css" type= "text/css" rel="stylesheet" />

  </head>
  <body>
    <div class="related">
      <h3>Просмотр</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="Словарь-указатель"
             accesskey="I">словарь</a></li>
        <li class="right" >
          <a href="ch50.html" title="Утилиты Exim’a"
             accesskey="N">следующий</a> |</li>
        <li class="right" >
          <a href="ch48.html" title="Использование Exim’a как клиента без очереди сообщений"
             accesskey="P">предыдущий</a> |</li>
        <li><a href="index.html">Specification of the Exim Mail Transfer Agent 4.70 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="ch49-00">
<span id="id1"></span><h1>Файлы логов<a class="headerlink" href="#ch49-00" title="Ссылка на этот заголовок">¶</a></h1>
<p>Exim пишет три различных лога, называемых - главный лог, лог отклонённых, и лог паники:</p>
<ul class="simple">
<li>В главном логе записывается приход каждого сообщения, и каждая доставка, по одной строке на каждый случай. Формат - компактен насколько возможно, с целью попытаться уменьшить размер лог-файлов. Двухсимвольная последовательности флага облегчают выбор этих строк. Множество иных событий записывается в главный лог. Некоторые из них - необязательны, управляемые включением или выключением параметра переключателя логов <strong>log_selector</strong>. Perl`овый скрипт, называемый <em>eximstats</em>, производит простой анализ файлов главного лога, предоставляется в дистрибутиве Exim`a (смотрите раздел <a class="reference internal" href="ch50.html#ch50-07"><em>50.7</em></a>).</li>
<li>В лог отклонённых записывается информация из сообщений, которые были отклонены как результат конфигурационных параметров (т.е. по причинам политик). Первая строка каждого отклонения - копия строки, которая, также, пишется в главный лог. Затем, если заголовки сообщения были прочитаны во время записи лога, их содержимое пишется в этот лог. Доступны лишь оригинальные строки заголовков; заголовки добавленные ACL - не записываются в лог. Вы можете использовать лог отклонённых для проверки, что ваши политики работают корректно; на загруженных хостах это может быть более легким чем сканирование главного лога на отклонённые сообщения. Вы можете подавить запись лога отклонённых путём установки <strong>write_rejectlog</strong> в ложь.</li>
<li>Когда происходят определённые серьёзные ошибки, Exim делает запись в лог паники. Если ошибка достаточно серьёзная, Exim прекращает работу. Записи в лог паники, обычно, также пишутся в главный лог, но могут теряться среди массы других записей. В обычных обстоятельствах, лог паники должен быть пустой. Хорошая идея - проверять его регулярно (или скрипт в <em>cron</em>, который будет это делать), с целью узнать о проблемах. Когда Exim yе может открыть свой лог паники, он пытается, как последнее средство, записать в системный лог (syslog). Он открывается с LOG_PID+LOG_CONS и кодом средства LOG_MAIL. Само сообщение пишется с приоритетом LOG_CRIT.</li>
</ul>
<p>Каждая строка лога начинается со штампа времени, в формате, показанном в следующем примере. Отметьте, что многие из примеров, показанных в этой части, с переносом строк. В файле логов, это было бы одной строкой:</p>
<div class="highlight-python"><pre>2001-09-16 16:09:47 SMTP connection from [127.0.0.1] closed
  by QUIT</pre>
</div>
<p>По умолчанию, штампы времени в локальной временной зоне. Есть два способа это изменить:</p>
<ul>
<li><p class="first">Вы можете установить параметр <strong>timezone</strong> в иную временную зону; в частности, вы можете установить:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">timezone</span> <span class="o">=</span> <span class="n">UTC</span>
</pre></div>
</div>
<p>для штампов времени в UTC (который - GMT).</p>
</li>
<li><p class="first">Вы можете установить <strong>log_timezone</strong> в истину, для добавления временной зоны к штампу времени, например:</p>
<div class="highlight-python"><pre>2003-04-25 11:17:07 +0100 Start queue run: pid=12762</pre>
</div>
<p>По умолчанию, Exim не включает свой идентификатор процесса в строки логов, но вы можете запросить это путём задания лог селектора “pid” (смотрите раздел <a class="reference internal" href="#ch49-15"><em>49.15</em></a>). Когда это задано, выводиться pid процесса в квадратных скобках, сразу после времени и даты.</p>
</li>
</ul>
<div class="section" id="ch49-01">
<span id="id2"></span><h2>Где пишутся логи<a class="headerlink" href="#ch49-01" title="Ссылка на этот заголовок">¶</a></h2>
<p>Логи могут быть записаны в локальные файлы, или в syslog, или и туда и туда. Однако, нужно отметить, что многие реализации syslog используют в качестве транспорта UDP, и ненадёжны, в смысле, что не гарантируется прибытие сообщений на хост записи логов, и при этом порядок сообщений не обязательно поддерживается. Также сообщалось, что на больших файлах логов (десятки мегабайт), возможно, вам необходимо настроить syslog, для предотвращения синхронизации файла при каждой записи - на linux было замечено, что это вызывало 90% загрузку центрального процессора.</p>
<p>Назначение для логов Exim`a настраивается путём установки LOG_FILE_PATH в <em>Local/Makefile</em>, или путём установки <strong>log_file_path</strong> в рабочей конфигурации. Эта, последняя, строка раскрывается, и, таким образом, она может содержать, например, ссылки на имя хоста:</p>
<div class="highlight-python"><pre>log_file_path = /var/log/$primary_hostname/exim_%slog</pre>
</div>
<p>Вообще, желательна установка строки в <em>Local/Makefile</em>, вместо рабочей конфигурации, поскольку в этом случае установка доступна с самого начала выполнения Exim`a. Иначе, если будет нужно записать в лог что-то до чтения конфигурационного файла (например, ошибку в конфигурационном файле), он не сможет использовать путь который вы хотите, и может оказаться не в состоянии записать в лог вообще что бы то ни было.</p>
<p>Значение LOG_FILE_PATH или <strong>log_file_path</strong> - список разделённый двоеточиями, в настоящее время ограниченный максимум двумя элементами. Это - единственный параметр, где не может использоваться средство для изменения разделителя списка. Этот список всегда должен быть разделён двоеточиями. Если элемент в списке - “syslog”, тогда используется syslog; иначе, элемент должен быть абсолютным путём, содержащим “%s” как точку, где должны быть вставлены “main”, “reject”, или “panic”, или быть пустым, подразумевая использование пути по умолчанию.</p>
<p>Когда Exim сталкивается с пустым элементом в списке, он ищет список, заданный путём LOG_FILE_PATH, и использует первый найденный элемент, если он не пустой, или не “syslog”. Это означает, что в <strong>log_file_path</strong> может использоваться пустой элемент, для обозначения “использовать путь заданный при сборке”. Если элемента не существует, лог файлы пишутся в поддиректорию <em>log</em>, в директории спула. Это эквивалентно установке:</p>
<div class="highlight-python"><pre>log_file_path = $spool_directory/log/%slog</pre>
</div>
<p>Если вы не определили что-то при компиляции или в рабочей конфигурации, логи пишутся по указанному пути.</p>
<p>Путь к логам может содержать “%D”, если в имени логов используется штамп даты - смотрите раздел <a class="reference internal" href="#ch49-03"><em>49.3</em></a>, ниже.</p>
<p>Вот - некоторые примеры возможных установок:</p>
<div class="highlight-python"><pre>LOG_FILE_PATH=syslog                     syslog only
LOG_FILE_PATH=:syslog                    syslog and default path
LOG_FILE_PATH=syslog : /usr/log/exim_%s  syslog and specified path
LOG_FILE_PATH=/usr/log/exim_%s           specified path only</pre>
</div>
<p>Если в списке более двух путей, используется первый, и в лог записывается паническая ошибка.</p>
</div>
<div class="section" id="ch49-02">
<span id="id3"></span><h2>Запись лога в локальные файлы, которые периодически маршрутизируются<a class="headerlink" href="#ch49-02" title="Ссылка на этот заголовок">¶</a></h2>
<p>Некоторые операционные системы предоставляют централизованные и стандартизованные методы для ротации файлов логов. Для тех, которые этого не делают, предоставляется скрипт утилиты с именем <strong>exicyclog</strong> (смотрите раздел <a class="reference internal" href="ch50.html#ch50-06"><em>50.6</em></a>). Он переименовывает и сжимает главный лог, и лог отклонённых при каждом его вызове. Может быть настроено максимальное число оставляемых старых логов. Предполагается, что этот скрипт запускается как ежедневное задание “cron”.</p>
<p>Процесс доставки Exim`a открывает главный лог когда ему первый раз необходимо в него записать, и оставляет его открытым в случае, если требуется последующая запись - например, если для одного и того же сообщения производится несколько различных доставок. Однако, удалённые SMTP-доставки могут занять много времени, и это означает, что файл может оставаться открытым после его переименования, если <em>exicyclog</em>, или что-то подобное используется для переименования файлов логов на регулярной основе <a class="footnote-reference" href="#id19" id="id4">[1]</a>. Для гарантии, что переключение лог-файлов будет замечено как можно быстрее, Exim вызывает <em>stat()</em> для имени главных логов, до повторного использования открытых файлов, и если файл не существует, или изменилась его иногда, старый файл закрывается, и Exim пробует открыть пустой главный лог. Таким образом, старый лог может оставаться открытым довольно долго, но никакие процессы Exim`a в него не пишут, как только он был переименован.</p>
</div>
<div class="section" id="ch49-03">
<span id="id5"></span><h2>Штамп даты на файлах логов<a class="headerlink" href="#ch49-03" title="Ссылка на этот заголовок">¶</a></h2>
<p>Вместо ротации файлов главного лога и лога отклонённых путём их периодического переименовывания, некоторые любят использовать файлы, чьи имена содержат штамп времени, например, <em>mainlog-20031225</em>. Штамп времени имеет форму <em>yyyymmdd</em>. Exim обладает поддержкой для этого способа работы. Он включается путём установки параметра <strong>log_file_path</strong> в путь, который содержит “%D” в точке где требуется штамп даты. Например:</p>
<div class="highlight-python"><pre>log_file_path = /var/spool/exim/log/%slog-%D
log_file_path = /var/log/exim-%s-%D.log
log_file_path = /var/spool/exim/log/%D-%slog</pre>
</div>
<p>Как и прежде, “%s” заменяется на “main” или “reject”; вот - примеры имён создаваемых этим примером:</p>
<div class="highlight-python"><pre>/var/spool/exim/log/mainlog-20021225
/var/log/exim-reject-20021225.log
/var/spool/exim/log/20021225-mainlog</pre>
</div>
<p>Когда задана эта форма логов, Exim автоматически переключается на новые файлы по ночам. Он не предпринимает никаких попыток для сжатия старых логов; вам придётся написать свой скрипт, который будет это делать. Вы не должны запускать <em>exicyclog</em> с этой формой записи в лог.</p>
<p>Местоположение лога паники, также определяется путём <strong>log_file_path</strong>, но на него не ставиться штамп даты, поскольку ротация лога паники не имеет смысла. При создании имени лога паники, “%D” удаляется из строки. Дополнительно, если он идёт немедленно после слэша, следующий не алфавитно-цифровой символ - удаляется; иначе, удаляется предшествующий не алфавитно-цифровой символ. Таким образом, предыдущие три примера, привели бы к таким логам паники:</p>
<div class="highlight-python"><pre>/var/spool/exim/log/paniclog
/var/log/exim-panic.log
/var/spool/exim/log/paniclog</pre>
</div>
</div>
<div class="section" id="syslog">
<span id="ch49-04"></span><h2>Запись в лог через syslog<a class="headerlink" href="#syslog" title="Ссылка на этот заголовок">¶</a></h2>
<p>Использование syslog не изменяет того, как Exim записывает в лог, или формат его сообщений, исключая одно отношение. Если <strong>syslog_timestamp</strong> установлена в ложь, штамп времени в строках лога Exim`a пропускается, когда строка посылается в syslog. Кроме того, те же самые строки пишутся в syslog как в файлы логов. Средство (“facility”) syslog установлено в LOG_MAIL, и по умолчанию, программа именуется “exim”, но вы можете изменить это с помощью параметров <strong>syslog_facility</strong> и <strong>syslog_processname</strong>, соответственно. Если Exim скомпилирован с SYSLOG_LOG_PID установленным в <em>Local/Makefile</em> (это, значение по умолчанию, в <em>src/EDITME</em>), тогда, на системах, которые разрешают это (все, исключая ULTRIX), флаг LOG_PID - установлен так, чтобы вызов <em>syslog()</em> добавлял pid, также как и время и имя хоста, в каждую строку. Три потока логов распределяются по приоритетам syslog следующим образом:</p>
<ul class="simple">
<li><em>mainlog</em> - маппится на LOG_INFO</li>
<li><em>rejectlog</em> - маппится на LOG_NOTICE</li>
<li>paniclog* - маппится на LOG_ALERT</li>
</ul>
<p>Многие строки пишутся в оба - <em>mainlog</em> и <em>rejectlog</em>, а некоторые пишутся и в <em>mainlog</em> и в <em>paniclog</em>, таким образом, они будут дублироваться, если syslod их направит в одно место. Вы можете подавить дубликацию путём установки <strong>syslog_duplication</strong> в ложь.</p>
<p>Иногда, строки логов Exim`a бывают очень длинными, и некоторые записи <strong>rejectlog</strong> содержат несколько строк, когда включаются заголовки. Для борьбы с этими обоими случаями, записываемые в syslog вхождения разделяются в отдельные вызовы <em>syslog()</em> по внутренним новым строкам, и, также, после максимум, 870 знаков. (Это учитывает максимальную длину строки syslog - 1024, когда добавлены дополнения, типа штампа времени.) Если вы запускаете замену syslog, которая может обработать строки длинней чем 1024 символа, разрешённые <span class="target" id="index-0"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc3164.html"><strong>RFC 3164</strong></a>, вы должны установить</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">SYSLOG_LONG_LINES</span><span class="o">=</span><span class="n">yes</span>
</pre></div>
</div>
<p>в <em>Local/Makefile</em> до сборки Exim`a. Это предотвращает разбитие Exim`ом длинных строк, но всё ещё разбирает внутренние новые строки во вхождениях лога <em>reject</em>.</p>
<p>Для облегчения повторной сборки разбитых строк, каждый компонент разбитого вхождения начинается со строки формы <em>[&lt;n&gt;/&lt;m&gt;]</em> или <em>[&lt;n&gt;&lt;m&gt;]</em>, где <em>&lt;n&gt;</em> - компонент числа, и <em>&lt;m&gt;</em> - полное число компонентов вхождения. Разделитель <em>/</em> используется когда строка разбита из-за того, что она слишком длинная; если же она разбита из-за внутренней новой строки, используется разделитель <em>*. Например, предположим что ограничение длинны 50 вместо 870, следующий пример был бы результатом типичного отклонения сообщения в *mainlog</em> (LOG_INFO), дополнительно, каждая строка начинается с времени, имени хоста, и pid, добавляемых syslog:</p>
<div class="highlight-python"><pre>[1/5] 2002-09-16 16:09:43 16RdAL-0006pc-00 rejected from
[2/5]  [127.0.0.1] (ph10): syntax error in 'From' header
[3/5]  when scanning for sender: missing or malformed lo
[4/5] cal part in "&lt;&gt;" (envelope sender is &lt;ph10@cam.exa
[5/5] mple&gt;)</pre>
</div>
<p>Та же самая ошибка могла бы привести к следующим строкам записанным в <em>rejectlog</em> (LOG_NOTICE):</p>
<div class="highlight-python"><pre>[1/18] 2002-09-16 16:09:43 16RdAL-0006pc-00 rejected fro
[2/18] m [127.0.0.1] (ph10): syntax error in 'From' head
[3/18] er when scanning for sender: missing or malformed
[4/18]  local part in "&lt;&gt;" (envelope sender is &lt;ph10@cam
[5\18] .example&gt;)
[6\18] Recipients: ph10@some.domain.cam.example
[7\18] P Received: from [127.0.0.1] (ident=ph10)
[8\18]        by xxxxx.cam.example with smtp (Exim 4.00)
[9\18]        id 16RdAL-0006pc-00
[10/18]        for ph10@cam.example; Mon, 16 Sep 2002 16:
[11\18] 09:43 +0100
[12\18] F From: &lt;&gt;
[13\18]   Subject: this is a test header
[18\18]   X-something: this is another header
[15/18] I Message-Id: &lt;E16RdAL-0006pc-00@xxxxx.cam.examp
[16\18] le&gt;
[17\18] B Bcc:
[18/18]   Date: Mon, 16 Sep 2002 16:09:43 +0100</pre>
</div>
<p>Строки логов, которые не слишком длинные, или не содержат символа новой строки, пишутся в syslog без модификации.</p>
<p>Если используется только syslog, монитор Exim`a не может показывать логи, если syslog не направляет <em>mainlog</em> в файл на локальном хосте, и переменная окружения EXIMON_LOG_FILE_PATH не указывает монитору, где он находится.</p>
</div>
<div class="section" id="ch49-05">
<span id="id6"></span><h2>Флаги строк логов<a class="headerlink" href="#ch49-05" title="Ссылка на этот заголовок">¶</a></h2>
<p>На каждое пришедшее сообщение, в логи записывается одна строка, и для каждой успешной, неуспешной, и задержанной доставки. Эти строки могут быть выбраны по отличительным двухсимвольным флагам, которые идут сразу за штампом времени. Флаги таковы:</p>
<div class="highlight-python"><pre>&lt;=      прибытие сообщения
=&gt;      нормальная доставка сообщения
-&gt;      дополнительный адрес в той же доставке
*&gt;      доставка подавлена путём -N
**      доставка неудачна; отправляется рикошет
==      доставка задержана; временная проблема</pre>
</div>
</div>
<div class="section" id="ch49-06">
<span id="id7"></span><h2>Запись в лог приёма сообщений<a class="headerlink" href="#ch49-06" title="Ссылка на этот заголовок">¶</a></h2>
<p>Формат однострочного вхождения в главном логе, который пишется для каждого полученного сообщения, показан в простом примере, ниже, который разбит на несколько строк, чтобы уместиться на странице:</p>
<div class="highlight-python"><pre>2002-10-31 08:57:53 16ZCW1-0005MB-00 &lt;= kryten@dwarf.fict.example
  H=mailer.fict.example [192.168.123.123] U=exim
  P=smtp S=5678 id=&lt;incoming message id&gt;</pre>
</div>
<p>Адрес, немедленно сопровождаемый “&lt;=” - адрес отправителя конверта. Рикошет отображается с адресом отправителя “&lt;&gt;”, и, если он создан локально, он сопровождается элементом в форме:</p>
<div class="highlight-python"><pre>R=&lt;message id&gt;</pre>
</div>
<p>являющимся ссылкой на сообщение, которое вызвало отсылку рикошета.</p>
<p>Для сообщений с других хостов, поля “H” и “U” идентифицируют удалённый хост и запись идентификатора <span class="target" id="index-1"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc1413.html"><strong>RFC 1413</strong></a> пользователя, пославшего сообщение, если оно было принято. Число данное в квадратных скобках - IP адрес, отсылавшего хоста. Если тут единственное, не заключённое в скобки, имя хоста в поле “H”, как выше, значит оно было проверено на соответствие IP адресу (смотрите параметр <strong>host_lookup</strong>). Если имя в круглых скобках, то это имя, указанное удалённым хостом в SMTP команде HELO или EHLO, и оно не было проверено. Если проверка приводит к имени отличающемуся от данного в HELO или EHLO, проверенное имя показано первым, сопровождаемое именем HELO или EHLO в круглых скобках.</p>
<p>Неверно сконфигурированные хосты (и те, кто подделывает почту) иногда помещают IP адрес, с квадратными скобками, или без, в команду HELO или EHLO, приводя к записям в логах, типа этих примеров:</p>
<div class="highlight-python"><pre>H=(10.21.32.43) [192.168.8.34]
H=([10.21.32.43]) [192.168.8.34]</pre>
</div>
<p>Это может запутывать. Можно положиться лишь на последний адрес в квадратных скобках.</p>
<p>Для локально созданных сообщений (т.е. не переданных через TCP/IP), поле “H” - пропущено, и поле “U” содержит логин вызвавшего Exim.</p>
<p>Для всех сообщений, поле “P” определяет протокол, используемый для получения сообщения. Это значение сохраняется в $received_protocol. В случае входящего SMTP сообщения, значение указывает, использовались ли расширения SMTP (ESMTP), шифрование, или аутентификация. Если сессия SMTP была шифрованная, есть дополнительное поле “X”, в котором записан тип использовавшегося шифрования.</p>
<p>Протокол устанавливается в “esmtpsa” или “esmtpa” для сообщений переданных от хостов которые аутентифицировались, используя команду SMTP AUTH. Первое значение используется когда SMTP соединение шифрованное (“secure”). В этом случае, есть дополнительный пункт “A=”, сопровождаемый именем использовавшегося аутентификатора. Если аутентифицированная идентификация была установлена аутентифкационного параметра “server_set_id”, она также записывается в лог, отделяемая двоеточием от имени аутентификатора.</p>
<p>Поле “id” записывает существующий идентификатор сообщения, если он есть. Размер принятого сообщения даётся в поле “S”. Когда сообщение доставляется, заголовки могут быть удалены или добавлены, таким образом, размер доставленных копий сообщений может не соответствовать этому значению (и в действительности могут отличаться друг от друга).</p>
<p>Параметр <strong>log_selector</strong> может использоваться для запроса записи в лог дополнительных данных, при получении сообщения. Смотрите раздел <a class="reference internal" href="#ch49-15"><em>49.15</em></a>.</p>
</div>
<div class="section" id="ch49-07">
<span id="id8"></span><h2>Запись в лог доставки сообщения<a class="headerlink" href="#ch49-07" title="Ссылка на этот заголовок">¶</a></h2>
<p>Формат однострочного вхождения в главном логе, который пишется для каждой доставки показан в одном из примеров ниже, для локальной и удалённой доставки соответственно. Каждый пример был разбит на две строки, чтобы вписаться в страницу:</p>
<div class="highlight-python"><pre>2002-10-31 08:59:13 16ZCW1-0005MB-00 =&gt; marv
  &lt;marv@hitch.fict.example&gt; R=localuser T=local_delivery
2002-10-31 09:00:10 16ZCW1-0005MB-00 =&gt;
  monk@holistic.fict.example R=dnslookup T=remote_smtp
  H=holistic.fict.example [192.168.234.234]</pre>
</div>
<p>Для обычных локальных доставок, оригинальный адрес даётся в угловых скобках после финального адреса доставки, который может быть трубой или файлом. Если между оригинальным и финальным адресом существует промежуточный, последний даётся в круглых скобках после заключительного адреса. Поля “R” и “T” записывают маршрутизатор и транспорт которые использовались при обработке адреса.</p>
<p>Если после успешной локальной доставки запускается теневой транспорт, к концу строки о успешной доставке добавляется элемент, в форме:</p>
<div class="highlight-python"><pre>ST=&lt;shadow transport name&gt;</pre>
</div>
<p>Если теневой транспорт был неуспешен, сообщение о ошибке помещается в конце, в круглых скобках.</p>
<p>Когда в одной доставке включён более чем один адрес (например, две команды SMTP RCPT в одной транзакции), второй и последующие адреса помечаются флагами с “-&gt;” вместо “=&gt;”. Когда два и более сообщения отправляются по одному SMTP соединению, для второго и последующих сообщений в строках логов за IP адресом вставляется звёздочка.</p>
<p>Создание сообщения с ответом, путём файла фильтра, записывается в лог как “доставка” на адрес, которому предшествует “&gt;”.</p>
<p>Параметр <strong>log_selector</strong> может использоваться для запроса записи в лог дополнительных данных, при получении сообщения. Смотрите раздел <a class="reference internal" href="#ch49-15"><em>49.15</em></a>.</p>
</div>
<div class="section" id="ch49-08">
<span id="id9"></span><h2>Доставки от которых отказались<a class="headerlink" href="#ch49-08" title="Ссылка на этот заголовок">¶</a></h2>
<p>Когда от сообщения отказались, как результат команды “seen finish” появившейся в файле фильтра, который не создает никаких доставок, в логи записывается вхождение такой формы:</p>
<div class="highlight-python"><pre>2002-12-10 00:50:49 16auJc-0001UB-00 =&gt; discarded
  &lt;low.club@bridge.example&gt; R=userforward</pre>
</div>
<p>для указаний, почему не записаны в лог никакие доставки. Когда от сообщения отказываются по причине что синоним привёл к “:blackhole:” <a class="footnote-reference" href="#id20" id="id10">[2]</a>, строка логов будет такой:</p>
<div class="highlight-python"><pre>1999-03-02 09:44:33 10HmaX-0005vi-00 =&gt; :blackhole:
  &lt;hole@nowhere.example&gt; R=blackhole_router</pre>
</div>
</div>
<div class="section" id="ch49-09">
<span id="id11"></span><h2>Отсроченные доставки<a class="headerlink" href="#ch49-09" title="Ссылка на этот заголовок">¶</a></h2>
<p>Когда сообщение задержано, в лог записывается строка следующей формы:</p>
<div class="highlight-python"><pre>2002-12-19 16:20:23 16aiQz-0002Q5-00 == marvin@endrest.example
  R=dnslookup T=smtp defer (146): Connection refused</pre>
</div>
<p>В случае удалённых доставок, ошибка - то, что давалось для последнего пробовавшегося IP адреса. Детали индивидуальной SMTP ошибки также пишутся в лог, таким образом, вышеупомянутой строке предшествовало  бы что-то вроде этого:</p>
<div class="highlight-python"><pre>2002-12-19 16:20:23 16aiQz-0002Q5-00 Failed to connect to
  mail1.endrest.example [192.168.239.239]: Connection refused</pre>
</div>
<p>Когда задержанный адрес пропускается, поскольку не наступило его время повтора, в лог записывается сообщение, но это может быть подавлено путём установки соответствующего значения в <strong>log_selector</strong>.</p>
</div>
<div class="section" id="ch49-10">
<span id="id12"></span><h2>Ошибки доставки<a class="headerlink" href="#ch49-10" title="Ссылка на этот заголовок">¶</a></h2>
<p>Если доставка неуспешна по причине невозможности смаршрутизировать адрес, в лог записывается строка такой формы:</p>
<div class="highlight-python"><pre>1995-12-19 16:20:23 0tRiQz-0002Q5-00 ** jim@trek99.example
  &lt;jim@trek99.example&gt;: unknown mail domain</pre>
</div>
<p>Если доставка неудачна в транспортное время, показываются маршрутизатор и транспорт, и включается ответ удалённого хоста, как в этом примере:</p>
<div class="highlight-python"><pre>2002-07-11 07:14:17 17SXDU-000189-00 ** ace400@pb.example
  R=dnslookup T=remote_smtp: SMTP error from remote mailer
  after pipelined RCPT TO:&lt;ace400@pb.example&gt;: host
  pbmail3.py.example [192.168.63.111]: 553 5.3.0
  &lt;ace400@pb.example&gt;...Addressee unknown</pre>
</div>
<p>Слово “pipelined” указывает, что было использовано расширение SMTP PIPELINING. Смотрите <strong>hosts_avoid_esmtp</strong> в транспорте <strong>smtp</strong> для способа отключения PIPELINING. Строки логов для всех форм неудачной доставки помечаются флагом “**”.</p>
</div>
<div class="section" id="ch49-11">
<span id="id13"></span><h2>Поддельные доставки<a class="headerlink" href="#ch49-11" title="Ссылка на этот заголовок">¶</a></h2>
<p>Если доставка, фактически, не имела места, поскольку для её подавления использовался параметр <strong>-N</strong>, в лог пишется обычная строка доставки, исключая, что “=&gt;” заменяется на “*&gt;”.</p>
</div>
<div class="section" id="ch49-12">
<span id="id14"></span><h2>Завершение<a class="headerlink" href="#ch49-12" title="Ссылка на этот заголовок">¶</a></h2>
<p>Строка в форме</p>
<div class="highlight-python"><pre>2002-10-31 09:00:11 16ZCW1-0005MB-00 Completed</pre>
</div>
<p>пишется в главный лог когда сообщение должно быть удалено из спула, в конце его обработки.</p>
</div>
<div class="section" id="ch49-13">
<span id="id15"></span><h2>Краткое изложение полей в строках логов<a class="headerlink" href="#ch49-13" title="Ссылка на этот заголовок">¶</a></h2>
<p>Краткое изложение идентификаторов полей, которые используются в строках логов, показано в следующей таблице:</p>
<div class="highlight-python"><pre>A     имя аутентификатора (и необязательный id)
С     подтверждение SMTP после доставки
      список команд в “no mail in SMTP session”
CV    статус проверки сертификата
D     длительность “no mail in SMTP session”
DN    характерное имя от сертификата узла
DT    в строке =&gt; - время затраченное на доставку
F     адрес отправителя (в строках доставки)
H     имя хоста и IP адрес
I     используемый локальный интерфейс
id    идентификатор сообщения для входящего сообщения
P     в строке &lt;= - используемый протокол
      в =&gt; и ** строках - обратный путь
QT    в строках =&gt; - время нахождения в очереди на данный момент
      в строках “Completed” - время нахождения в очереди
R     в строках &lt;= - ссылка для локального рикошета
      в ** и == строках - имя маршрутизатора
S     размер сообщения
ST    имя теневого транспорта
T     в строках &lt;= - тема сообщения
      в ** и == строках - имя транспорта
U     локальный пользователь или идентификатор RFC 1413
X     способ шифрования TLS</pre>
</div>
</div>
<div class="section" id="ch49-14">
<span id="id16"></span><h2>Другие записи логов<a class="headerlink" href="#ch49-14" title="Ссылка на этот заголовок">¶</a></h2>
<p>Различные иные типы записей время от времени пишутся в логи. Большинство из них - очевидны. Чаще всего:</p>
<ul>
<li><p class="first"><em>retry time not reached</em> - предварительно, адрес подвергся временной ошибке при маршрутизации, или локальной доставке, и время его повтора ещё не наступило. Это сообщение не пишется в индивидуальный файл лога, если это не происходит во время первой попытки доставки.</p>
</li>
<li><p class="first"><em>retry time not reached for any host</em> - предварительно, адрес подвергся временной ошибке в процессе удалённой доставки, и ни для одного из хостов, к которым был смаршрутизирован адрес, не наступило время повтора.</p>
</li>
<li><p class="first"><em>spool file locked</em> - Попытка доставки сообщения не может произойти, поскольку некоторые иной процесс Exim`a уже работают над ним. Это довольно обычно, если процесс обработки очереди запускается через короткие интервалы. Сервисный скрипт <em>exiwhat</em> может быть использован чтобы узнать, чем занимаются процессы Exim`a.</p>
</li>
<li><p class="first"><em>error ignored</em> - есть несколько обстоятельств, которые могут привести к этому сообщению:</p>
<ol class="arabic simple">
<li>Exim не может доставить рикошет, чей возраст больше чем <strong>ignore_bounce_errors_after</strong>. От рикошета отказываются.</li>
<li>Файл фильтра установил доставку используя параметр <strong>noerror</strong>, и доставка неудачна. От доставки отказываются.</li>
<li>Доставка настроенная путём настроенного маршрутизатора</li>
</ol>
<blockquote>
<div><div class="highlight-python"><pre>сerrors_to = &lt;&gt;</pre>
</div>
<p>неудачна. От доставки отказываются.</p>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="ch49-15">
<span id="id17"></span><h2>Сокращение или увеличение того, что записывается в лог<a class="headerlink" href="#ch49-15" title="Ссылка на этот заголовок">¶</a></h2>
<p>Путём установки глобального параметра <strong>log_selector</strong>, вы можете отключить некоторое записи в лог по умолчанию Exim`a, или вы можете запросить дополнительные записи в лог. Значение <strong>log_selector</strong> составлено из имён, с предшествующим символом плюса или минуса. Например:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">log_selector</span> <span class="o">=</span> <span class="o">+</span><span class="n">arguments</span> <span class="o">-</span><span class="n">retry_defer</span>
</pre></div>
</div>
<p>Список элементов выбора лога, указаны в следующей таблице, с значением по умолчанию отмеченным звёздочкой:</p>
<table border="1" class="docutils">
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">*acl_warn_skipped</th>
<th class="head">пропущенное в ACL утверждение <strong>warn</strong></th>
</tr>
<tr class="row-even"><th class="head">address_rewrite</th>
<th class="head">перезапись адреса</th>
</tr>
<tr class="row-odd"><th class="head">all_parents</th>
<th class="head">все родители в =&gt; строке</th>
</tr>
<tr class="row-even"><th class="head">arguments</th>
<th class="head">аргументы командной строки</th>
</tr>
<tr class="row-odd"><th class="head">*connection_reject</th>
<th class="head">отклонения соединений</th>
</tr>
<tr class="row-even"><th class="head">*delay_delivery</th>
<th class="head">задержка немедленной доставки</th>
</tr>
<tr class="row-odd"><th class="head">deliver_time</th>
<th class="head">время затраченное на выполнение доставки</th>
</tr>
<tr class="row-even"><th class="head">delivery_size</th>
<th class="head">добавляет S=nnn в строки =&gt;</th>
</tr>
<tr class="row-odd"><th class="head">*dnslist_defer</th>
<th class="head">задержки поисков в списках DNS (RBL)</th>
</tr>
<tr class="row-even"><th class="head">*etrn</th>
<th class="head">команды ETRN</th>
</tr>
<tr class="row-odd"><th class="head">*host_lookup_failed</th>
<th class="head">в названии параметра всё сказано</th>
</tr>
<tr class="row-even"><th class="head">ident_timeout</th>
<th class="head">таймаут соединения ident</th>
</tr>
<tr class="row-odd"><th class="head">incoming_interface</th>
<th class="head">входящий интерфейс в строке &lt;=</th>
</tr>
<tr class="row-even"><th class="head">incoming_port</th>
<th class="head">входящий порт в строке &lt;=</th>
</tr>
<tr class="row-odd"><th class="head">*lost_incoming_connection</th>
<th class="head">что сказано в названии параметра (включая таймауты)</th>
</tr>
<tr class="row-even"><th class="head">outgoing_port</th>
<th class="head">добавляет удалённый порт к строке =&gt;</th>
</tr>
<tr class="row-odd"><th class="head">*queue_run</th>
<th class="head">начало и завершение обработки очереди</th>
</tr>
<tr class="row-even"><th class="head">queue_time</th>
<th class="head">время в очереди для одного получателя</th>
</tr>
<tr class="row-odd"><th class="head">queue_time_overall</th>
<th class="head">время в очереди для всего сообщения</th>
</tr>
<tr class="row-even"><th class="head">pid</th>
<th class="head">идентификатор процесса Exim&#8217;a</th>
</tr>
<tr class="row-odd"><th class="head">received_recipients</th>
<th class="head">получатели в cтроках &lt;=</th>
</tr>
<tr class="row-even"><th class="head">received_recipients</th>
<th class="head">отправители в строках &lt;=</th>
</tr>
<tr class="row-odd"><th class="head">*rejected_header</th>
<th class="head">содержимое заголовка в логе отклонённых</th>
</tr>
<tr class="row-even"><th class="head">*retry_defer</th>
<th class="head">“retry time not reached”</th>
</tr>
<tr class="row-odd"><th class="head">return_path_on_delivery</th>
<th class="head">помещает путь возврата в строки =&gt; и **</th>
</tr>
<tr class="row-even"><th class="head">sender_on_delivery</th>
<th class="head">добавляет отправителя к строкам =&gt;</th>
</tr>
<tr class="row-odd"><th class="head">*sender_verify_fail</th>
<th class="head">ошибка проверки отправителя</th>
</tr>
<tr class="row-even"><th class="head">*size_reject</th>
<th class="head">отклонение по причине слишком большого размера</th>
</tr>
<tr class="row-odd"><th class="head">*skip_delivery</th>
<th class="head">пропуск доставки в обработчике очереди</th>
</tr>
<tr class="row-even"><th class="head">smtp_confirmation</th>
<th class="head">подтверждение SMTP в строках =&gt;</th>
</tr>
<tr class="row-odd"><th class="head">smtp_connection</th>
<th class="head">подключения SMTP</th>
</tr>
<tr class="row-even"><th class="head">smtp_incomplete_transaction</th>
<th class="head">незавершенная транзакция SMTP</th>
</tr>
<tr class="row-odd"><th class="head">smtp_no_mail</th>
<th class="head">сессия без команд MAIL</th>
</tr>
<tr class="row-even"><th class="head">smtp_protocol_error</th>
<th class="head">ошибки протокола SMTP</th>
</tr>
<tr class="row-odd"><th class="head">smtp_syntax_error</th>
<th class="head">ошибки синтаксиса SMTP</th>
</tr>
<tr class="row-even"><th class="head">subject</th>
<th class="head">содержимое Subject: в строках &lt;=</th>
</tr>
<tr class="row-odd"><th class="head">tls_certificate_verified</th>
<th class="head">статус проверки сертификата</th>
</tr>
<tr class="row-even"><th class="head">*tls_cipher</th>
<th class="head">метод шифрования TLS в строках &lt;= и =&gt;</th>
</tr>
<tr class="row-odd"><th class="head">tls_peerdn</th>
<th class="head">TLS узел DN в строках &lt;= и =&gt;</th>
</tr>
<tr class="row-even"><th class="head">unknown_in_list</th>
<th class="head">неудача поиска DNS при сравнении списка</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-odd"><td>all</td>
<td>все вышеупомянутые</td>
</tr>
</tbody>
</table>
<p>Дополнительные детали для каждого из этих элементов таковы:</p>
<ul>
<li><p class="first"><strong>acl_warn_skipped</strong>: Когда пропускается <strong>warn</strong> утверждение ACL, поскольку одно из его условий не может быть оценено, о этом эффекте записывается строка лога, если этот селектор установлен.</p>
</li>
<li><p class="first"><strong>address_rewrite</strong>: Это применяется к обоим перезаписям, - глобальной и транспортной, но не к перезаписи в фильтрах, работающих от непривилегированного пользователя (поскольку такой пользователь не имеет доступа к логам).</p>
</li>
<li><p class="first"><strong>all_parents</strong>: Обычно, лишь оригинальный и финальный адреса записываются в лог в строках доставки; с этим селектором, промежуточные предки даются между ними, в круглых скобках.</p>
</li>
<li><p class="first"><strong>arguments</strong>: Это вызывает запись Exim`ом аргументов, с которыми он был вызван в главный лог, с текущей рабочей директорией. Это - отладочная возможность, добавленная для облегчения узнавания того, как некоторые MUA вызывают вызывают <em>/usr/sbin/sendmail</em>. Запись в лог не происходит, если Exim отказался от root`овых привилегий, поскольку он вызывается с параметрами <strong>-C</strong> или <strong>-D</strong>. Аргументы которые пусты, или которые содержат пустое пространство - помещаются в кавычки. Непечатаемые символы показываются в последовательностях начинающихся с обратной косой черты. Это средство не может записывать в лог неизвестные аргументы, поскольку аргументы проверяются до чтения конфигурационного файла. Единственный способ записать в лог такие случаи - вставка скрипта, типа <em>util/logargs.sh</em>, между вызывающим и Exim`ом.</p>
</li>
<li><p class="first"><strong>connection_reject</strong>: Запись в лог производится каждый раз когда отклоняется входящее SMTP подключение, по любой причине.</p>
</li>
<li><p class="first"><strong>delay_delivery</strong>: Запись в лог производится каждый раз когда процесс доставки не запускается для входящего сообщения, поскольку загрузка слишком высока, или слишком много сообщений передано в одном соединении. Запись в лог не происходит, если процесс доставки не начат по причине что установлен параметр <strong>queue_only</strong> или используется <strong>-odq</strong>.</p>
</li>
<li><p class="first"><strong>deliver_time</strong>: Для каждой доставки, количество реального времени затраченного на реальную доставку записывается в лог как DT=&lt;time&gt;, например, DT=1s.</p>
</li>
<li><p class="first"><strong>delivery_size</strong>: Для каждой доставки, размер сообщения добавляется к строке “=&gt;”, с тегом “S=”.</p>
</li>
<li><p class="first"><strong>dnslist_defer</strong>: Запись в логи делается если попытка поиска хоста в чёрных списках DNS возвращает временную ошибку.</p>
</li>
<li><p class="first"><strong>etrn</strong>: Каждая полученная действительная команда ETRN записывается в лог, до запуска ACL, фактически определяющей, принята она или нет. Неверная команда ERTN, или переданная во время обработки сообщения - не записывается в лог этим селектором (смотрите <strong>smtp_syntax_error</strong> и <strong>smtp_protocol_error</strong>).</p>
</li>
<li><p class="first"><strong>host_lookup_failed</strong>: Когда поиск IP-адресов хоста не в состоянии найти какой-либо адрес, или когда поиск по IP адресу не возвращает имени, в логи записывается строка. Эта запись в лог не применяется к прямым поискам DNS при маршрутизации почтовых адресов, но применяется к поискам “по имени”.</p>
</li>
<li><p class="first"><strong>ident_timeout</strong>: Строка в лог записывается каждый раз когда попытка подключиться к клиентскому порту ident привела к таймауту.</p>
</li>
<li><p class="first"><strong>incoming_interface</strong>: Интерфейс на котором получено сообщение добавляется к строке “&lt;=” как IP-адрес в квадратных скобках, помеченный путём “I=” и сопровождаемый двоеточием и номером порта. Локальный интерфейс и порт также добавляется к прочим строкам логов SMTP, например, “SMTP connection from”, и строкам о отклонениях.</p>
</li>
<li><p class="first"><strong>incoming_port</strong>: Удалённый номер порта, с которого было получено сообщение, добавляется к записям логов и строкам заголовков “Received:”, сопровождаемый IP-адресом в квадратных скобках, и отделённый от него двоеточием. Это осуществляется путём изменения значения помещённого в переменные $sender_fullhost и $sender_rcvhost. Запись удалённого номера порта стала более важной в связи с использованием NAT (смотрите <span class="target" id="index-2"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2505.html"><strong>RFC 2505</strong></a>).</p>
</li>
<li><p class="first"><strong>lost_incoming_connection</strong>: Строка лога записывается когда входящее SMTP соединение неожиданно обрывается.</p>
</li>
<li><p class="first"><strong>outgoing_port</strong>: Номер удалённого порта, добавляемый к строкам доставки (которые содержат тэг “=&gt;”), сопровождаемый IP-адресом. Этот параметр не включен в настройки по умолчанию, поскольку в большинстве обычных конфигураций удалённый порт всегда 25 (порт SMTP).</p>
</li>
<li><p class="first"><strong>pid</strong>: Текущий идентификатор процесса добавляется к каждой строке лога, в квадратных скобках, сразу после даты и времени</p>
</li>
<li><p class="first"><strong>queue_run</strong>: Запись в лог запуска и завершения обработки очереди.</p>
</li>
<li><p class="first"><strong>queue_time</strong>: Количество времени, которое сообщение находилось в очереди на локальном хосте записываются в лог как “QT=&lt;time&gt;” в строках доставки (=&gt;), например, QT=3m45s. Часы запускаются когда Exim начинает приём сообщения, таким образом оно включает время приёма как и время доставки для текущего адреса. Это означает, что оно может быть больше чем разница между временем прибытия и временем доставки в логе, поскольку строка лога о прибытии не пишется, пока сообщение не будет успешно получено.</p>
</li>
<li><p class="first"><strong>queue_time_overall</strong>: Количество времени которое сообщение было в очереди на локальном хосте записывается в лог как “QT=&lt;time&gt;” в строках “Completed”, например, QT=3m45s. Часы запускаются когда Exim начинает приём сообщения, таким образом оно включает время приёма как и полное время доставки.</p>
</li>
<li><p class="first"><strong>received_recipients</strong>: Получатели сообщения перечислены в главном логе, как только получено сообщение. Список появляется в конце строки лога после слова “for”, который записывается когда сообщение принято. Адреса перечислены после того как они были квалифицированы, но до того как имела место перезапись адресов. Получатели от которых отказались из-за ACL для MAIL или RCPT не фигурируют в этом списке.</p>
</li>
<li><p class="first"><strong>received_sender</strong>: Не перезаписанный оригинальный отправитель сообщения добавляется в конце строки лога, которая записывается по прибытии сообщения, после слова “from” (до получателей, если, также, установлена <strong>received_recipients</strong>).</p>
</li>
<li><p class="first"><strong>rejected_header</strong>: Если во время записи о отклонении, в лог отклонённых, был получен заголовок сообщения, полный заголовок добавляется в лог. Запись в лог заголовков может быть индивидуально отключен для сообщений которые были отклонены функцией <em>local_scan()</em> (смотрите раздел <a class="reference internal" href="ch42.html#ch42-02"><em>42.2</em></a>).</p>
</li>
<li><p class="first"><strong>retry_defer</strong>: Строка лога записывается, если доставка задержана по причине что не достигнуто время повтора. Однако, сообщение “retry time not reached” всегда пропускается от индивидуальных логов сообщений, после первой попытки доставки.</p>
</li>
<li><p class="first"><strong>return_path_on_delivery</strong>: Путь возврата, который передаётся с сообщением, включается в строки доставки и рикошета, используя тэг “P=”. Он пропускается, если не было фактической доставки, например, при неудаче маршрутизации, или при доставке в <em>/dev/null</em>, или в <em>:blackhole:</em>.</p>
</li>
<li><p class="first"><strong>sender_on_delivery</strong>: Адрес отправителя сообщения, добавляемый к каждой строке доставки и рикошета, помеченный “F=” (для “from”). Это - оригинальный отправитель, который передан с сообщением; он - не обязательно то же самое, что и исходящий путь возврата.</p>
</li>
<li><p class="first"><strong>sender_verify_fail</strong>: Если этот селектор не установлен, не пишется отдельная строка о ошибке проверки отправителя. Строка лога для отклонения SMTP команд содержит лишь “sender verify failed”, таким образом, некоторые детали теряются.</p>
</li>
<li><p class="first"><strong>size_reject</strong>: Каждый раз, когда сообщение отклоняется потому, что слишком велико, пишется строка лога.</p>
</li>
<li><p class="first"><strong>skip_delivery</strong>: Строка лога пишется каждый раз, когда сообщение пропущено в течение работы очереди, поскольку оно заморожено, или поскольку его уже доставляет иной процесс. Сообщение которое пишется - “spool file is locked”.</p>
</li>
<li><p class="first"><strong>smtp_confirmation</strong>: Ответ на финальную “.” в диалоге SMTP для исходящего сообщения добавляется в строку лога доставки, в форме “C=&lt;text&gt;”. Большинство MTA (включая Exim), в этом ответе, возвращают идентификационную строку.</p>
</li>
<li><p class="first"><strong>smtp_connection</strong>: Строка лога пишется каждый раз, когда SMTP соединение установлено или закрыто, исключая соединения от хостов которые совпадают с <strong>hosts_connection_nolog</strong>. (В противоположность, <strong>lost_incoming_connection</strong> - применяться лишь когда закрытие неожиданное.) Она применяется к соединениям от локальных процессов, которые используют “-bs”, точно так же как и к подключениям по TCP/IP. Если соединение разорвано в середине сообщения, строка лога пишется всегда, вне зависимости от установки этого селектора, если же он не установлен, то в начале и в конце соединения ничего не пишется.</p>
<p>Для TCP/IP соединений к даемону Exim`a, число текущих соединений включается в сообщение лога для каждого нового соединения, но записывается, что счётчик сброшен, если даемон перезапущен. Также, поскольку соединения закрываются (и закрытие записывается в лог) в подпроцессах, счётчик может не включать соединения, которые были закрыты, но чьё завершение ещё не заметил даемон. Таким образом, когда возможно совпадение открытия и закрытия соединений в логе, значение записываемого в лог счётчика может быть не совсем точным.</p>
</li>
<li><p class="first"><strong>smtp_incomplete_transaction</strong>: Когда почтовая транзакция прервана по причине RSET, QUIT, потери соединения, или как-то иначе, инцидент записывается в лог, и отправитель сообщения плюс любые принятые получатели включаются в строку лога. Это может предоставить очевидные доказательства атак по словарю.</p>
</li>
<li><p class="first"><strong>smtp_no_mail</strong>: Строка пишется в главный лог всякий раз когда принятое SMTP соединение завершается без отданное команды MAIL. Это включает оба случая - когда соединение уничтожено, и случай когда использовалось QUIT. Это не включает случай когда соединение отвергнуто в начале (путём ACL, или поскольку слишком много соединений, или ещё почему-то). Эти случаи уже имеют собственные записи в логах.</p>
<p>Записываемые строки логов содержат средства идентификации клиента в обычной форме, сопровождаемые “D=” и временем, которое записывает длительность соединения. Если соединение аутентифицировано, этот факт записывается в лог точно также как для входящих сообщений, с элементом “A=”. Если соединение зашифровано, могут появляться элементы “CV=”, “DN=” и “X=”, также как для входящего сообщения, контролируемые теми же самыми параметрами записи в лог.</p>
<p>В конце, если любая SMTP команда была отдана в процессе соединения, к строке лога добаляется элемент “C=”, листинг использовавшихся команд. Например:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">C</span><span class="o">=</span><span class="n">EHLO</span><span class="p">,</span><span class="n">QUIT</span>
</pre></div>
</div>
<p>показывает что клиент выдал команду QUIT сразу после EHLO. Если команд более 20, показываются последние 20, предваряемые “...”. Однако, установка по умолчанию - 10 для <strong>smtp_accep_max_nonmail</strong>, и, соединение будет в лбюом случае оборвано до обработки 20 не-MAIL команд.</p>
</li>
<li><p class="first"><strong>smtp_protocol_error</strong>: Строка лога пишется для каждой встреченной ошибки протокола SMTP. Exim не обладает прекрасным обнаружением всех ошибок протокола, из-за задержек передачи и конвейерных обработок. Если клиент оповещался о PIPELINING, сервер Exim предполагает что клиент будет его использовать, и поэтому не подсчитывает “ожидаемые” ошибки (например, RCPT переданную после отклонённого MAIL) как ошибки протокола.</p>
</li>
<li><p class="first"><strong>smtp_syntax_error</strong>:  Строка лога пишется для каждой встреченной ошибки синтаксиса SMTP. Неизвестная команда рассматривается как ошибка синтаксиса. Для внешних соединений, даётся идентификатор хоста; для внутренних соединений использующих <strong>-bs</strong>, даётся идентификатор отправителя (обычно - вызывающий пользователь).</p>
</li>
<li><p class="first"><strong>subject</strong>: Тема сообщения  добавляется в строку лога прибытия, с предшествующим “T=” (“T” - “topic”, т.к. “S” уже используется для “size”). Любые “слова” MIME в теме - декодируются. Параметр <strong>print_topbitchars</strong> задаёт, должны ли символы с кодом более 127 регистрироваться неизменными, или они должны быть превращены в последовательности с обратным слэшом.</p>
</li>
<li><p class="first"><strong>tls_certificate_verified</strong>: Дополнительный пункт добавляется к строке “&lt;=” и “=&gt;”, когда используется TLS. Элемент “CV=yes” - если сертификат узла был проверен, и “CV=no” - если нет.</p>
</li>
<li><p class="first"><strong>tls_cipher</strong>: Когда сообщение посылается или принимается через шифрованное соединение, используемый метод шифрования добавляется к строке лога, с предшествующим “X=”.</p>
</li>
<li><p class="first"><strong>tls_peerdn</strong>: Когда сообщение посылается или принимается через шифрованное соединение, и сертификат предоставляется удалёным хостом, DN узла добавляется к строке лога, с предшествующим “DN=”.</p>
</li>
<li><p class="first"><strong>unknown_in_list</strong>: Эта установка вызывает запись в лог когда результат сравнения списка неудачен по причине неудачи поиска в DNS.</p>
</li>
</ul>
</div>
<div class="section" id="ch49-16">
<span id="id18"></span><h2>Лог сообщения<a class="headerlink" href="#ch49-16" title="Ссылка на этот заголовок">¶</a></h2>
<p>В дополнение к главному файлу логов, Exim пишет лог-файл для каждого сообщения, которое он обрабатывает. Имена этих персональных логов для сообщений - идентификаторы сообщений, и они хранятся в поддиректории <em>msglog</em> директории спула. Каждый лог сообщения содержит копии строк логов, которые касаются сообщения. Это облегчает выяснение статуса индивидуального сообщения без необходимости поиска по главному логу. Лог сообщения удаляется после завершения обработки сообщения, если не задана <strong>preserve_message_logs</strong>, но она должна использоваться с большой осторожностью, поскольку логи могут очень быстро заполнить ваш диск.</p>
<p>На сильно загруженных системах, может быть желательным отключить использование персональных логов сообщений, для уменьшения дискового ввода-вывода. Это может быть сделано путём установки параметра <strong>message_logs</strong> в ложь.</p>
<table class="docutils footnote" frame="void" id="id19" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[1]</a></td><td>имеется ввиду - постоянно - раз в сутки, например - прим. lissyara</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id20" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id10">[2]</a></td><td>чёрная дыра - /dev/null - прим. lissyara</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Содержание</a></h3>
  <ul>
<li><a class="reference internal" href="#">Файлы логов</a><ul>
<li><a class="reference internal" href="#ch49-01">Где пишутся логи</a></li>
<li><a class="reference internal" href="#ch49-02">Запись лога в локальные файлы, которые периодически маршрутизируются</a></li>
<li><a class="reference internal" href="#ch49-03">Штамп даты на файлах логов</a></li>
<li><a class="reference internal" href="#syslog">Запись в лог через syslog</a></li>
<li><a class="reference internal" href="#ch49-05">Флаги строк логов</a></li>
<li><a class="reference internal" href="#ch49-06">Запись в лог приёма сообщений</a></li>
<li><a class="reference internal" href="#ch49-07">Запись в лог доставки сообщения</a></li>
<li><a class="reference internal" href="#ch49-08">Доставки от которых отказались</a></li>
<li><a class="reference internal" href="#ch49-09">Отсроченные доставки</a></li>
<li><a class="reference internal" href="#ch49-10">Ошибки доставки</a></li>
<li><a class="reference internal" href="#ch49-11">Поддельные доставки</a></li>
<li><a class="reference internal" href="#ch49-12">Завершение</a></li>
<li><a class="reference internal" href="#ch49-13">Краткое изложение полей в строках логов</a></li>
<li><a class="reference internal" href="#ch49-14">Другие записи логов</a></li>
<li><a class="reference internal" href="#ch49-15">Сокращение или увеличение того, что записывается в лог</a></li>
<li><a class="reference internal" href="#ch49-16">Лог сообщения</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="ch48.html" title="предыдущая глава">Использование Exim&#8217;a как клиента без очереди сообщений</a></li>
      <li>Next: <a href="ch50.html" title="следующая глава">Утилиты Exim&#8217;a</a></li>
  </ul></li>
</ul>
  <h3>На этой странице</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/ch49.txt"
           rel="nofollow">Показать исходный текст</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Быстрый поиск</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Искать" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Введите слова для поиска или имя модуля, класса или функции.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy; Copyright 2011, Exim Maintainers.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
    </div>
  </body>
</html>
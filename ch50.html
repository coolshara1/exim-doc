
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Утилиты Exim’a &mdash; Specification of the Exim Mail Transfer Agent 4.70 documentation</title>
    
    <link rel="stylesheet" href="static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '4.70',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/underscore.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <script type="text/javascript" src="static/translations.js"></script>
    <link rel="top" title="Specification of the Exim Mail Transfer Agent 4.70 documentation" href="index.html" />
    <link rel="next" title="Монитор Exim’a" href="ch51.html" />
    <link rel="prev" title="Файлы логов" href="ch49.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="static/small_flask.css" type= "text/css" rel="stylesheet" />

  </head>
  <body>
    <div class="related">
      <h3>Просмотр</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="Словарь-указатель"
             accesskey="I">словарь</a></li>
        <li class="right" >
          <a href="ch51.html" title="Монитор Exim’a"
             accesskey="N">следующий</a> |</li>
        <li class="right" >
          <a href="ch49.html" title="Файлы логов"
             accesskey="P">предыдущий</a> |</li>
        <li><a href="index.html">Specification of the Exim Mail Transfer Agent 4.70 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="exim-a">
<span id="ch50-00"></span><h1>Утилиты Exim&#8217;a<a class="headerlink" href="#exim-a" title="Ссылка на этот заголовок">¶</a></h1>
<p>Множество скриптовых утилит и программ поставляются с Exim&#8217;ом и описано в этой части. Также, есть Exim Monitor, который описывается в следующей части. Описанные утилиты таковы:</p>
<table border="1" class="docutils">
<colgroup>
<col width="27%" />
<col width="22%" />
<col width="51%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><a class="reference internal" href="#ch50-01"><em>50.1</em></a></td>
<td><em>exiwhat</em></td>
<td>список, что делают процессы Exim&#8217;a</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#ch50-02"><em>50.2</em></a></td>
<td><em>exiqgrep</em></td>
<td>выбор из очереди</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#ch50-03"><em>50.3</em></a></td>
<td><em>exiqsumm</em></td>
<td>суммирование очереди</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#ch50-04"><em>50.4</em></a></td>
<td><em>exigrep</em></td>
<td>поиск по главному логу</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#ch50-05"><em>50.5</em></a></td>
<td><em>exipick</em></td>
<td>выбор сообщений по различным критериям</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#ch50-06"><em>50.6</em></a></td>
<td><em>exicyclog</em></td>
<td>ротация лог-файлов</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#ch50-07"><em>50.7</em></a></td>
<td><em>eximstats</em></td>
<td>выбор статистики из логов</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#ch50-08"><em>50.8</em></a></td>
<td><em>exim_checkaccess</em></td>
<td>проверка приёма адреса с данного IP</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#ch50-09"><em>50.9</em></a></td>
<td><em>exim_dbmbuild</em></td>
<td>сборка файла DBM</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#ch50-10"><em>50.10</em></a></td>
<td><em>exinext</em></td>
<td>извлечение информации повторов</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#ch50-11"><em>50.11</em></a></td>
<td><em>exim_dumpdb</em></td>
<td>дамп БД подсказок</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#ch50-11"><em>50.11</em></a></td>
<td><em>exim_tidydb</em></td>
<td>очистка БД подсказок</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#ch50-11"><em>50.11</em></a></td>
<td><em>exim_fixdb</em></td>
<td>правка БД подсказок</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#ch50-15"><em>50.15</em></a></td>
<td><em>exim_lock</em></td>
<td>блокировка файла почтового ящика (mailbox)</td>
</tr>
</tbody>
</table>
<p>Другая утилита, которая могла бы использоваться на сайтах с многими MTA - <em>exilog</em> Tom Kistner’s. Он обеспечивает визуализацию логов от многих серверов Exim&#8217;a. Для деталей, смотрите <a class="reference external" href="http://duncanthrax.net/exilog/">http://duncanthrax.net/exilog/</a>.</p>
<div class="section" id="exim-a-exiwhat">
<span id="ch50-01"></span><h2>Поиск, что делают процессы Exim&#8217;a (exiwhat)<a class="headerlink" href="#exim-a-exiwhat" title="Ссылка на этот заголовок">¶</a></h2>
<p>На операционных системах, которые могут замещать системные вызовы после получения сигнала (большинство современных OS), процесс Exim&#8217;a отвечает на сигнал SIGUSR1, путём записи строки описывающей, что он делает в файл <em>exim-process.info</em> в директории спула Exim&#8217;a. Скрипт <em>exiwhat</em> посылает сигнал всем процессам Exim&#8217;a, которые он находит, вначале очистив файл. После чего он ждёт секунду, чтобы позволить процессам Exim&#8217;a отреагировать, до отображения результатов. Для успешного управления <em>exiwhat</em>, вы должны обладать достаточными привилегиями для посылки сигнала процессам Exim&#8217;a, таким образом, обычно, он запускается от пользователя root.</p>
<div class="admonition warning">
<p class="first admonition-title">Предупреждение</p>
<p class="last">Это неэффективный процесс. Он предназначен для случайного использования администраторами системы. Неразумно, например, настраивать скрипт, который через короткие периоды посылает процессам Exim&#8217;a сигнал SIGUSR1.</p>
</div>
<p>К сожалению, команда <em>ps</em> которую <em>exiwhat</em> использует для нахождения процессов Exim&#8217;a, различна в разных операционных системах. Мало того, что используются различные параметры, но и формат вывода - различен. Для этого, есть некоторые системные конфигурационные параметры, которые настраивают работу <em>exiwhat</em>. Если вам кажется, что он не работает, проверьте следующие параметры компиляции:</p>
<ul class="simple">
<li>EXIWHAT_PS_CMD - команда для запуска “ps”</li>
<li>EXIWHAT_PS_ARG - аргумент для “ps”</li>
<li>EXIWHAT_EGREP_ARG - аргумент для “egrep”, для выбора из вывода “ps”</li>
<li>EXIWHAT_KILL_ARG - аргумент для команды “kill”</li>
</ul>
<p>Пример типичного вывода <em>exiwhat</em>:</p>
<div class="highlight-python"><pre>164 daemon: -q1h, listening on port 25
10483 running queue: waiting for 0tAycK-0002ij-00 (10492)
10492 delivering 0tAycK-0002ij-00 to mail.ref.example
  [10.19.42.42] (editor@ref.example)
10592 handling incoming call from [192.168.243.242]
10628 accepting a local non-SMTP message</pre>
</div>
<p>Первое число в строке вывода - номер процесса. Третья строка была разделена, чтоб уместиться в странице.</p>
</div>
<div class="section" id="exiqgrep">
<span id="ch50-02"></span><h2>Селективный просмотр очереди (exiqgrep)<a class="headerlink" href="#exiqgrep" title="Ссылка на этот заголовок">¶</a></h2>
<p>Эта утилита - скрипт на Perl, предоставленный Matt Hubbard. Он запускает</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">exim</span> <span class="o">-</span><span class="n">bpu</span>
</pre></div>
</div>
<p>для получения списка очереди, содержащего лишь недоставленных получателей, и затем выбирает из вывода сообщения, которые совпадают с заданными критериями. Доступны следующие параметры выбора:</p>
<ul>
<li><p class="first"><strong>-f &lt;regex&gt;</strong>
Совпадение с адресом отправителя. Проверяемое поле окружено угловыми скобками, таким образом, вы можете проверить рикошеты используя</p>
<div class="highlight-python"><pre>exiqgrep -f '^&lt;&gt;$'</pre>
</div>
</li>
<li><p class="first"><strong>-r &lt;regex&gt;</strong>
Совпадение с адресом получателя. Проверяемое поле не окружено угловыми скобками.</p>
</li>
<li><p class="first"><strong>-s &lt;regex&gt;</strong>
Совпадение с полем размера.</p>
</li>
<li><p class="first"><strong>-y &lt;seconds&gt;</strong>
Совпедение сообщений, которые раньше данного времени.</p>
</li>
<li><p class="first"><strong>-o &lt;seconds&gt;</strong>
Совпедение сообщений, которые старше данного времени.</p>
</li>
<li><p class="first"><strong>-z</strong>
Совпадение лишь с замороженными сообщениями.</p>
</li>
<li><p class="first"><strong>-x</strong>
Совпадение лишь с незамороженными сообщениями.</p>
</li>
</ul>
<p>Следующие параметры управляют форматированием вывода:</p>
<ul class="simple">
<li><strong>-c</strong>
Показ только счётчика совпавших сообщений.</li>
<li><strong>-l</strong>
Длинный формат - показывает полную информацию, как в выводе Exim&#8217;a. Это - значение по умолчанию.</li>
<li><strong>-i</strong>
Показывает лишь идентификаторы сообщений.</li>
<li><strong>-b</strong>
Краткий формат - одна строка на сообщение.</li>
<li><strong>-R</strong>
Показывает сообщения в обратном порядке.</li>
</ul>
<p>Есть ещё один параметр, <strong>-h</strong>, которая выводит список всех паарметров.</p>
</div>
<div class="section" id="exiqsumm">
<span id="ch50-03"></span><h2>Подведение итогов очереди (exiqsumm)<a class="headerlink" href="#exiqsumm" title="Ссылка на этот заголовок">¶</a></h2>
<p>Утилита <strong>exiqsumm</strong> - скрипт на Perl, который читает вывод <tt class="docutils literal"><span class="pre">exim</span> <span class="pre">-bp</span></tt> и сложение сообщений в очереди. Таким образом, вы можете использовать его путём запуска команды типа такой:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">exim</span> <span class="o">-</span><span class="n">bp</span> <span class="o">|</span> <span class="n">exiqsumm</span>
</pre></div>
</div>
<p>Вывод состоит из одной строки для каждого домена, который имеет ожидающие сообщения, как в следующем примере:</p>
<div class="highlight-python"><pre>3   2322   74m   66m  msn.com.example</pre>
</div>
<p>Каждая строка перечисляет висящие доставки для домена, их полный объём, и отрезки времени, которые ожидают самое старое и самое новое сообщения. Отметьте, что число зависших доставок больше чем число сообщений, когда сообщения имеют более одного получателя.</p>
<p>Итоговая строка выводится в конце. По умолчанию, вывод сортируется по доменному имени, но <em>exiqsumm</em> обладает параметрами <strong>-a</strong> и <strong>-c</strong>, вызывающих сортировку вывода по наиболее старым сообщениям, и по счётчику сообщений, соответственно. Также есть три параметра, которые делят сообщения для каждого домена в два или более подсчётчика: <strong>-b</strong> - отделяет рикошеты, <strong>-f</strong> - отделяет замороженные сообщения, и, <strong>-s</strong> - разделяет сообщения по их отправителю.</p>
<p>Вывод <tt class="docutils literal"><span class="pre">exim</span> <span class="pre">-bp</span></tt> содержит оригинальные адреса в сообщении, таким образом, он также применяется к выводу <em>exiqsumm</em>. Домены созданные из адресов в результате перенаправления и подстановки синонима - не включаются (если не использовался параметр <strong>one_time</strong> маршрутизатора <strong>redirect</strong> для конвертации из в адреса “верхнего уровня”).</p>
</div>
<div class="section" id="exigrep">
<span id="ch50-04"></span><h2>Извлечение специфической информации из лога (exigrep)<a class="headerlink" href="#exigrep" title="Ссылка на этот заголовок">¶</a></h2>
<p>Утилита <em>exigrep</em> - скрипт на Perl, который ищет по одному или нескольким главным логам элементы совпадающие с заданным шаблоном. Когда он находит совпадение, он извлекает все записи логов для уместного сообщения, а не только совпавшие с шаблоном. Таким образом, <em>exigrep</em> может извлекать полный лог для заданного сообщения, или всю почту для заданного пользователя, или для заданного хоста, например. Входные файлы должны быть в формате логов Exim&#8217;a или syslog. Если совпадающие строки логов не ассоциируются с определённым сообщением, то они включаются в вывод <em>exigrep</em> без каких-либо дополнительных строк. Использование:</p>
<div class="highlight-python"><pre>exigrep [-t&lt;n&gt;] [-I] [-l] [-v] &lt;pattern&gt; [&lt;log file&gt;] ...</pre>
</div>
<p>Если имя лог-файла не дано в командной строке, читается стандартный ввод.</p>
<p>Аргумент <strong>-t</strong> определяет число секунд. Он добавляет дополнительное условие для выбора сообщения. Сообщения которые являются полными, показываются лишь если они провели в очереди более чем <em>&lt;n&gt;</em> секунд.</p>
<p>По умолчанию, <em>exigrep</em> ищет регистронезависимо. Параметр <strong>-I</strong> делает его регистрозависимым. Это может повысить производительность при поиске по большим файлам журналов. Без <strong>-I</strong>, шаблон Perl&#8217;a проверяется с использованием параметра “/i”; c <strong>-I</strong> - без неё. В обоих случаях, возможно изменить регистрозависимость внутри шаблона, используя “(?i)” или “(?-i)”</p>
<p>Параметр <strong>-l</strong> - буквальная, для обработки всех символов шаблона как они есть. Иначе шаблон должен быть регулярным выражением Perl.  Сравнение шаблона нечувствительно к регистру. Если в командной строке не задано имя файла, читается стандартный ввод.</p>
<p>Параметр <strong>-v</strong> - инвертирует совпадение. Таким образом, выбираются строки не совпадающем с шаблоном.</p>
<p>Если местоположение команды <em>zcat</em> известно из определения ZCAT_COMMAND в <em>Local/Makefile</em>, <em>exigrep</em> автоматически передаёт файлы, чьи имена заканчиваются на COMPRESS_SUFFIX, через <em>zcat</em> и затем ищет.</p>
</div>
<div class="section" id="exipick">
<span id="ch50-05"></span><h2>Отбор сообщений по различным критериям (exipick)<a class="headerlink" href="#exipick" title="Ссылка на этот заголовок">¶</a></h2>
<p>Утилита John Jetmore - <em>exipick</em>, включена в дистрибутив Exim&#8217;a. Она выводит список сообщений из очереди согласно разнообразным критериям. Для детальной информации <em>exipick</em> посетите страницу <a class="reference external" href="http://www.exim.org/eximwiki/ToolExipickManPage">http://www.exim.org/eximwiki/ToolExipickManPage</a>, или запустите <em>exipick</em> с параметром <strong>&#8211;help</strong>.</p>
</div>
<div class="section" id="exicyclog">
<span id="ch50-06"></span><h2>Ротация лог-файлов (exicyclog)<a class="headerlink" href="#exicyclog" title="Ссылка на этот заголовок">¶</a></h2>
<p>Скрипт <em>exicyclog</em> может быть использован для ротации логов <em>mainlog</em> и <em>rejectlog</em>. В этом нет необходимости лишь если используется syslog, или если вы используете файлы логов со штампом даты в их именах (смотрите раздел <a class="reference internal" href="ch49.html#ch49-03"><em>49.3</em></a>). Некоторые операционные системы имеют собственные стандартные механизмы для ротации логов, и, если предпочитаете, они могут использоваться вместо <em>exicyclog</em>. Есть два варианта параметров командной строки для <em>exicyclog</em>:</p>
<ul class="simple">
<li><strong>-k &lt;count&gt;</strong> - определяет число оставляемых лог-файлов, замещает значение по умолчанию, установленное при сборке Exim&#8217;a. Значение по умолчанию этого счётчика - 10.</li>
<li><strong>-l &lt;path&gt;</strong> - определяет путь к файлам логов, в том же формате, что и в параметре Exim&#8217;a <em>log_file_path</em> (например, <em>/var/log/exim_%slog</em>), замещая значение по умолчанию скрипта, который находит значение из конфигурации Exim&#8217;a.</li>
</ul>
<p>Каждый раз при запуске <em>exicyclog</em> файлы передвигаются вниз на один. Если имя главного лока файлов - <em>mainlog</em> (по умолчанию), тогда при запуске <em>exicyclog</em> <em>mainlog</em> становиться <em>mainlog.01</em>, предыдущий <em>mainlog.01</em> в <em>mainlog.02</em> и т.д. до предела, установленного в скрипте или параметром <strong>-k</strong>. От файлы логов, чьи имена превысили лимит - отказываются. Лог отклонённых обрабатывается подобным образом.</p>
<p>Если лимит более 99, скрипт использует 3-х цифровые номера, типа <em>mainlog.001</em>, <em>mainlog.002</em>, и т.д. Если вы изменяете число менее 99 на большее чем 99, или наоборот, вы должны будете исправить имена существующих логов.</p>
<p>Если файл <em>mainlog</em> не существует, скрипт ничего не делает. Файлы которые достигли конца - удаляются. Все файлы чей номер более 01 - сжимаются, используя команду сжатия сконфигурированную установкой COMPRESS_COMMAND в <em>Local/Makefile</em>. Обычно, <em>exicyclog</em> запускается ежедневно из root`ового <em>crontab</em>, строкой формы:</p>
<div class="highlight-python"><pre>1 0 * * * su exim -c /usr/exim/bin/exicyclog</pre>
</div>
<p>предполагая, что вы используете для пользователя Exim&#8217;a имя “exim”. Вы можете запускать <em>exicyclog</em> от root`a, если вы этого желаете, но в этом нет необходимости.</p>
</div>
<div class="section" id="eximstats">
<span id="ch50-07"></span><h2>Почтовая статистика (eximstats)<a class="headerlink" href="#eximstats" title="Ссылка на этот заголовок">¶</a></h2>
<p>Скрипт на Perl с именем <em>eximstats</em> предоставлен для извлечения статистической информации из лог-файлов. Вывод - является простым текстом, или HTML. Логи Exim&#8217;a также поддерживаются системой “Lire”, сделанной LogReport Foundation <a class="reference external" href="http://www.logreport.org/">http://www.logreport.org/</a>.</p>
<p>Скрипт был нерабочим а течение долгого времени. Последняя версия - результат довольно большой переработки Steve Campbell. По умолчанию, даётся много информации, но есть параметры для подавления некоторых её частей. После любых параметров, аргументами должны быть файлы главного лога. Например:</p>
<div class="highlight-python"><pre>eximstats -nr /var/spool/exim/log/mainlog.01</pre>
</div>
<p>По умолчанию, <em>eximstats</em> извлекает информацию о числе и объёме сообщений полученных или доставленных на различные хосты. Информация сортирована по обоим, счётчику сообщений и по объёму, и высшие 50 хостов, в каждой категории, перечислены в стандартном выводе. Подобная информация, основанная на почтовых адресах или доменах, может быть запрошена при помощи различных параметров. Для сообщений, доставляемых и передаваемых локально, подобная статистика делается на основании пользователей.</p>
<p>Вывод, также включает общий счётчик и статистику о ошибках доставки, и гистограммы, показывающие число сообщений переданных и доставленных на каждый час дня. Доставки с более чем одним адресом в конверте (например, SMTP транзакция с более чем одной командой RCPT) подсчитывается как одна доставка.</p>
<p>Хотя, обычно, уведомляется о большем числе доставок чем приёмов (поскольку сообщения могут иметь более одного получателя), “eximstats” может сообщить сообщить о большем числе отправленных сообщений, чем было получено, даже если очередь пуста в начале и в конце рассматриваемого периода. Если входящее сообщение не содержит допустимых получателей, для него доставки не записываются. Рикошеты обрабатываются как полностью независимые сообщения.</p>
<p>Скрипт <em>eximstats</em> всегда выводит полное резюме, дающее объём и число переданных и доставленных сообщений, и число хостов вовлечённых в каждый случай. Также он выводит число задержанных сообщений (т.е. которые не были полностью доставлены в первую попытку), и число тех, у которых хотя бы один ардет был неудачен.</p>
<p>Оставшийся вывод находится в секциях, которые могут быть независимо отключены, или модифицированы различными параметрами. Он состоит из изложения доставко по транспортам, гистограмм сообщений переданных и доставленных по интервалу времени (по умолчанию - по часу), информации р времени сообщений проведённом в очереди, списке доставленных сообщений, списке высших 50 хостов по отправке, локальных отправителей, хостов назначения, и назначении локальных пользователей по счётчику и объёму, и списку происходивших ошибок доставки.</p>
<p>Информация о доставке перечисляет список сообщений которые были действительно доставлены, т.е. которые прибыли с удалённого хоста и были непосредственно доставлены на некоторый другой удалённый хост, без локальной обработки (например, без перенаправления или подстановки синонима).</p>
<p>Есть довольно много вариантов управления параметрами <em>eximstats</em>, для точного управления его выводом. Они непосредственно задокументированы в перл-скрипте, и могут быть извлечены путём запуска команды <em>perldoc</em> для скрипта. Например:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">perldoc</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">exim</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">eximstats</span>
</pre></div>
</div>
</div>
<div class="section" id="exim-checkaccess">
<span id="ch50-08"></span><h2>Проверка политики доступа (exim_checkaccess)<a class="headerlink" href="#exim-checkaccess" title="Ссылка на этот заголовок">¶</a></h2>
<p>Аргумент командной строки <strong>-bh</strong> позволяет вам запускать поддельную SMTP сессию с отладочным выводом, для проверки, что делает Exim когда применяет управление политиками ко входящей SMTP-почте. Однако, не все достаточно знакомы с протоколом SMTP, чтобы быть в состоянии полностью использовать <strong>-bh</strong>, и иногда вы лишь хотите ответа на вопрос - имеет ли какой-то адрес доступ? - без получения дополнительных деталей.</p>
<p>Утилита <em>exim_checkaccess</em> - “упакованная” (“packaged”) версия <strong>-bh</strong>. Она понимает два аргумента, IP-адрес и адрес электронной почты:</p>
<div class="highlight-python"><pre>exim_checkaccess 10.9.8.7 A.User@a.domain.example</pre>
</div>
<p>Утилита управляет вызовом Exim с параметром <strong>-bh</strong>, для тестирования, будет ли принят данный почтовый адрес в команде RCPT в соединении TCP/IP от хоста с заданным IP адресом. Вывод утилиты - или слово “accepted”, или ошибочный ответ SMTP, например:</p>
<div class="highlight-python"><pre>Rejected:
550 Relay not permitted</pre>
</div>
<p>При работе этого теста, утилита использует “&lt;&gt;” как отправителя конверта в команде MAIL, но вы можете это изменить, предоставляя дополнительные параметры. Их передают непосредственно команде Exim&#8217;a. Например, для задания, что тест запускается с адресом отправителя <em>himself&#64;there.example</em>, вы можете использовать:</p>
<div class="highlight-python"><pre>exim_checkaccess 10.9.8.7 A.User@a.domain.example \
                 -f himself@there.example</pre>
</div>
<p>Отметьте, что эти дополнительные элементы командной строки Exim&#8217;a нужно давать после двух обязательных элементов.</p>
<p>Поскольку <em>exim_checkaccess</em> использует <strong>-bh</strong>, он не выполняет обратный вызов при проведении проверки. Вы можете запустить проверку с включением обратного вызова используя <strong>-bhc</strong>, но это недоступно в “упакованной” (“packaged”) форме.</p>
</div>
<div class="section" id="dbm-exim-dbmbuild">
<span id="ch50-09"></span><h2>Создание файлов DBM (exim_dbmbuild)<a class="headerlink" href="#dbm-exim-dbmbuild" title="Ссылка на этот заголовок">¶</a></h2>
<p>Программа <em>exim_dbmbuild</em> читает входной файл, содержащий ключи и данные в формате используемом поиском <strong>lsearch</strong> (смотрите раздел <a class="reference internal" href="ch09.html#ch09-03"><em>9.3</em></a>). Она пишет файлы DBM используя имена синонимов в нижнем регистре как ключи, и оставшуюся информацию - как данные. Приведение к нижнему регистру может быть предотвращено путём вызова программы с параметром <strong>-nolc</strong>.</p>
<p>Завершающий ноль включается как часть ключевой строки Это ожидается типом поиска <strong>dbm</strong>. Однако, если задан параметр <strong>-nozero</strong>, <em>exim_dbmbuild</em> создаёт файлы без завершающих нулей в строках ключей, или строках данных. Тип поиска <strong>dbmnz</strong> может быть использован с такими файлами.</p>
<p>Программа требует двух аргументов: имя входного файла (который может быть одним дефисом, для индикации стандартного ввода), и именем выходного файла. Она создаёт вывод с временным именем, и, затем, переименовывает его, если всё успешно.</p>
<p>Если используется родной интерфейс DB (USE_DB установлена в компиляционном конфигурационном файле - это часто бывает в свободных версиях UNIX) два имени файлов должны быть различными, поскольку в этом режиме, функции Berkeley DB создают один выходной файл, используя точно заданное имя. Например:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">exim_dbmbuild</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">aliases</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">aliases</span><span class="o">.</span><span class="n">db</span>
</pre></div>
</div>
<p>читает файл системных синонимов, и создаёт его DBM версию в <em>/etc/aliases.db</em>.</p>
<p>В системах, которые используют шаблоны <em>ndbm</em> (большинство проприетарных версий UNIX), используются два файла, с суффиксами <em>.dir</em> и <em>.pag</em>. В этом окружении, суффиксы добавляются ко второму аргументу <em>exim_dbmbuild</em>, таким образом он может быть как и первый. Это также имеет место, когда функции Berkeley используются в совместимом режиме (хотя это не рекомендуется), поскольку в этом случае к имени файла добавляется суффикс <em>.db</em>.</p>
<p>Если происходит столкновение с двойным ключом <a class="footnote-reference" href="#id4" id="id1">[1]</a>, программа выводит предупреждение, и после завершения, она возвращает код 1, а не ноль, если не задан параметр <strong>-noduperr</strong>. По умолчанию, используется лишь первый дубликат - это делает её совместимой с поисками <strong>lsearch</strong>. Также, есть параметр <strong>-lastdup</strong>, вызывающий использование последнего дубликата вместо первого. Ещё есть параметр <strong>-nowarn</strong>, который останавливает перечисление двойных ключей на “stderr”. Для других ошибок, при которых новый файл, фактически, не создаётся, код возврата - 2.</p>
</div>
<div class="section" id="exinext">
<span id="ch50-10"></span><h2>Нахождение индивидуальных времён повторов (exinext)<a class="headerlink" href="#exinext" title="Ссылка на этот заголовок">¶</a></h2>
<p>Утилита, называемая <em>exinext</em> (по большей части - скрипт Perl), предоставляет возможность выбрать специфическую информацию из БД повторов. Данный почтовый домен (или полный адрес) ищется в хостах для этого домена, и выводит любую информацию повторов для хоста или домена. В настоящее время, информация повторов получается путём запуска <em>exim_dumpdb</em> (смотрите ниже), и последующей обработки её вывода. Например:</p>
<div class="highlight-python"><pre>$ exinext piglet@milne.fict.example
kanga.milne.example:192.168.8.1 error 146: Connection refused
  first failed: 21-Feb-1996 14:57:34
  last tried:   21-Feb-1996 14:57:34
  next try at:  21-Feb-1996 15:02:34
roo.milne.example:192.168.8.3 error 146: Connection refused
  first failed: 20-Jan-1996 13:12:08
  last tried:   21-Feb-1996 11:42:03
  next try at:  21-Feb-1996 19:42:03
  past final cutoff time</pre>
</div>
<p>Также, вы можете дать <em>exinext</em> локальную часть, без домена, и он выдаст любую информацию повторов для этой локальной части, в вашем домене по умолчанию. Идентификатор сообщения может использоваться для получения информации повторов относящейся к специфическому сообщению. Она существует лишь когда попытка доставки сообщения на удалённый зост привела к специфической для сообщения ошибки (смотрите раздел <a class="reference internal" href="ch45.html#ch45-02"><em>45.2</em></a>). <em>exinext</em> - не очень эффективен, но, как ожидается, он не будет часто запускаться.</p>
<p>Утилита <em>exinext</em> вызывает Exim для нахождения информации, типа расположения spool-директории. Утилита имеет параметры <strong>-C</strong> и <strong>-D</strong>, передаваемые командам “exim”. Первая определяет альтернативный конфигурационный файл Exim&#8217;a, и вторая устанавливает макрос для использования в конфигурационном файле. Эти особенности должны помочь в тестировании, но они, также, могли бы быть полезны в окружении, где используется более одного конфигурационного файла.</p>
</div>
<div class="section" id="ch50-11">
<span id="id2"></span><h2>Обслуживание БД подсказок<a class="headerlink" href="#ch50-11" title="Ссылка на этот заголовок">¶</a></h2>
<p>Три утилиты предоставляются для обслуживания файлов DBM, которые Exim использует для хранения его информации подсказок о доставках. Каждая программа требует двух аргументов. Первый определяет имя директории спула Exim&#8217;a, и второй - имя БД с которой она работает. Они, таковы:</p>
<ul class="simple">
<li><em>retry</em>: БД информации повторов</li>
<li><em>wait-&lt;transport name&gt;</em>: БД информации о сообщениях, ожидающих удалённых хостов</li>
<li><em>callout</em>: кэш обратных вызовов</li>
<li><em>ratelimit</em>: данные для осуществления условий ACL ограничения частоты</li>
<li><em>misc</em>: иные данные подсказок</li>
</ul>
<p>БД <em>misc</em> используется для</p>
<ul class="simple">
<li>Сериализации запусков ETRN (когда установлена <strong>smtp_etrn_serialize</strong>)</li>
<li>Сериализации доставки к специфическому хосту (когда <strong>smtp_etrn_serialize</strong> установлена в транспорте <strong>smtp</strong>)</li>
</ul>
</div>
<div class="section" id="exim-dumpdb">
<span id="ch50-12"></span><h2>exim_dumpdb<a class="headerlink" href="#exim-dumpdb" title="Ссылка на этот заголовок">¶</a></h2>
<p>Всё содержимое БД пишется на стандартный вывод, при помощи программы <em>exim_dumpdb</em>, которая не имеет параметров или аргументов кроме как имена спула и БД. Например, для дампа БД повторов:</p>
<div class="highlight-python"><pre>exim_dumpdb /var/spool/exim retry</pre>
</div>
<p>На каждое вхождение производится две строки вывода:</p>
<div class="highlight-python"><pre>T:mail.ref.example:192.168.242.242 146 77 Connection refused
31-Oct-1995 12:00:12 02-Nov-1995 12:21:39 02-Nov-1995 20:21:39 *</pre>
</div>
<p>Первый элемент в первой строке - ключ записи. Он начинается с одной из букв - “R” или “T”, в зависимоти от того, ссылается ли она на повтор маршрутизации, или транспорта. Для локальной доставки, следующая часть - локальный адрес; для удалённой доставки - это имя удалённого хоста, сопровождаемое его неудачным IP-адресом (за исключением случая когда <strong>retry_include_ip_address</strong> установлена в “false” в транспорте <strong>smtp</strong>). Если удалённый порт не стандартный (порт 25), он добавляется к IP-адресу. Затем следует код ошибки, дополнительный код ошибки, и текстовое описание ошибки.</p>
<p>Три времени во второй строке - время первой ошибки, время последней попытки доставки, и вычисленное время для следующей попытки. Строка завершается звёздочкой, если время убывания для последнего повтора было превышено.</p>
<p>Каждая строка вывода <em>exim_dumpdb</em> для БД <em>wait-xxx</em> содержит имя хоста, сопровождаемое списком идентификаторов для сообщений, которые есть, или ждут доставки на этот хост. Если для какого-то хоста очень много <a class="footnote-reference" href="#id5" id="id3">[2]</a>, могут быть замечены повторяющиеся записи, с номерами последовательности добавленным к имени хоста. Данные в этих записях, часто являются устаревшими, поскольку сообщение может быть маршрутизировано к нескольким альтернативным хостам, и Exim не предпринимает усилий для ведения перекрёстных ссылок.</p>
</div>
<div class="section" id="exim-tidydb">
<span id="ch50-13"></span><h2>exim_tidydb<a class="headerlink" href="#exim-tidydb" title="Ссылка на этот заголовок">¶</a></h2>
<p>Утилита <em>exim_tidydb</em> используется для упорядочивания содержимого БД подсказок. Если она запускается без параметров, она удаляет все записи, которые старше 30 дней. Возраст вычисляется из даты и времени, когда запись была последний раз обновлена. Отметьте, что в случае БД повторов, это не время с момента первого отказа. Информация о хосте, который лежал более 30 дней останется в БД, при условии, что записи обновляются достаточно часто.</p>
<p>Дата сокращения может быть изменена путём параметра <strong>-t</strong>, который должен сопровождаться временем. Например, для удаления всех записей которые старше недели из БД повторов:</p>
<div class="highlight-python"><pre>exim_tidydb -t 7d /var/spool/exim retry</pre>
</div>
<p>Обе БД - <em>wait-xxx</em> и <em>retry</em>, содержат элементы, которые вовлекают идентификаторы сообщений. Они фигурируют в форме данных в записях, где ключи - хосты, они были сообщениями ожидавшими этих хостов - и в последующем они - ключи для информации о сообщениях, перенёсших определённые типы ошибок. Когда <em>exim_tidydb</em> работает, производится проверка? что идентификаторы сообщений записанные в БД - это сообщения, которые всё ещё в очереди. Идентификаторы для сообщений, которые больше не существуют, удаляются из записей <em>wait-xxx</em>, и если остаются пустые записи, они удаляются. Для БД <em>retry</em>, удаляются записи чьи ключи - идентификаторы несуществующих сообщений. Утилита <em>exim_tidydb</em> выводит комментарии на стандартный вывод каждый раз, когда она удаляет информацию из БД.</p>
<p>Определённые записи автоматически удаляются Exim&#8217;ом когда они больше не нужны., но иные не удаляются. Например, если все MX хосты домена лежат, записи повторов создаются для каждого из них. Если первичный MX подымется первым, его запись удалится, когда Exim успешно доставит на него, но записи для других - останутся, поскольку Exim не пробовал эти хосты.</p>
<p>Это важно, поэтому, периодически запускайте <em>exim_tidydb</em> для всех БД подсказок. Вы должны делать это в спокойное время суток, поскольку она требует, чтобы БД была заблокирована (и, поэтому, недоступна Exim&#8217;y) когда она работает. Удаление записей из файлов DBM, обычно, не делает файл меньше, но все обычные библиотеки DBM умеют заново использовать освобождённое место. После начальной фазы увеличения в размере, БД, обычно, достигают точки, в которой они не становятся намного больше, пока они регулярно обслуживаются.</p>
<div class="admonition warning">
<p class="first admonition-title">Предупреждение</p>
<p class="last">Если вы никогда не будете запускать <em>exim_tidydb</em>, то вероятно, используемое БД подсказок место будет продолжать увеличиваться.</p>
</div>
</div>
<div class="section" id="exim-fixdb">
<span id="ch50-14"></span><h2>exim_fixdb<a class="headerlink" href="#exim-fixdb" title="Ссылка на этот заголовок">¶</a></h2>
<p>Программа <em>exim_fixdb</em> - утилита для интерактивной модификации БД. Главное её использование - для тестирования Exim&#8217;a, но, также, иногда она может быть полезна для обхода проблемы на живой системе. Она не имеет параметров, и её интерфейс несколько грубоват. На входе, она выводит подсказку в виде правой угловой скобки. В это время может быть введён ключ записи, и будут отображены данные для этой записи.</p>
<p>Если в следующем приглашении будет введено “d”, запись будет удалена. Для всех кроме БД <em>retry</em>, это - единственная возможная операция. Для БД <em>retry</em>, каждое поле предшествуется номером, и данные для индивидуальных полей могут быть изменены путём ввода номера поля, сопровождаемого новыми данными, например:</p>
<div class="highlight-python"><pre>&gt; 4 951102:1000</pre>
</div>
<p>сбросит время следующей попытки доставки. Значение времени даётся как последовательность цифровых пар для года, месяца, дня, часа, и минут. Двоеточия могут использоваться как необязательные разделители.</p>
</div>
<div class="section" id="exim-lock">
<span id="ch50-15"></span><h2>Обслуживание почтового ящика (exim_lock)<a class="headerlink" href="#exim-lock" title="Ссылка на этот заголовок">¶</a></h2>
<p>Утилита <em>exim_lock</em> блокирует файл почтового ящика, используя тот же самый алгоритм что и Exim. Для обсуждения проблем блокировки, смотрите раздел <a class="reference internal" href="ch26.html#ch26-03"><em>26.3</em></a>. <em>exim_lock</em> может быть использована для предотвращения какой-либо модификации почтового ящика Exim&#8217;ом или пользовательским агентом, при исследовании проблемы. Утилита требует имя файла как её первый аргумент. Если блокировка успешна, второй аргумент запускает команду (используя функцию “system()” С); если второй аргумент не задан, используется значение переменной окружения SHELL; если она не задана или пуста, запускается <em>/bin/sh</em>. Когда команда завершается, почтовый ящик разблокируется, и утилита завершается. Доступны следующие параметры:</p>
<blockquote>
<div><dl class="docutils">
<dt><strong>-fcntl</strong></dt>
<dd>Использовать для блокировки открытого почтового ящика <em>fcntl()</em>.</dd>
<dt><strong>-flock</strong></dt>
<dd>Использовать для блокировки открытого почтового ящика <em>flock()</em>, если операционная система это поддерживает.</dd>
<dt><strong>-interval</strong></dt>
<dd>Она должна сопровождаться числом, которое - число секунд; она устанавливает интервал засыпания между повторами (по умолчанию - 3).</dd>
<dt><strong>-lockfile</strong></dt>
<dd>Созавать файл блокировки до открытия почтового ящика.</dd>
<dt><strong>-mbx</strong></dt>
<dd>Блокировать почтовый ящик используя правила MBX.</dd>
<dt><strong>-q</strong></dt>
<dd>Убрать проверочный вывод.</dd>
<dt><strong>-retries</strong></dt>
<dd>Она должна сопровождаться числом; оно устанавливает сколько будет предприниматься попыток установить блокировку (по умолчанию - 10).</dd>
<dt><strong>-restore_time</strong></dt>
<dd>Этот параметр заставляет <em>exim_lock</em> восстанавливать время изменения и время чтения блокированного файла до выхода. Это позволяет получить вам доступ к блокированному почтовому ящику (например, чтобы получить резервную копию) не изменяя время, которое впоследствии увидит пользователь.</dd>
<dt><strong>-timeout</strong></dt>
<dd>Она должна сопровождаться числом, которое - число секунд; оно устанавливает таймаут который будет использоваться с блокировкой <em>fcntl()</em>. Если она не установлена (по умолчанию), используются неблокирующие вызовы.</dd>
<dt><strong>-v</strong></dt>
<dd>Выводить подробный вывод.</dd>
</dl>
</div></blockquote>
<p>Если не заданы <strong>-fcntl</strong>, <strong>-flock</strong>, <strong>-lockfile</strong> или <strong>-mbx</strong>, по умолчанию создаётся файл блокировки, и, также, на почтовом ящике используется блокировка <em>fcntl()</em>, что делает и Exim, по умолчанию. Использование <strong>-flock</strong> и <strong>-fcntl</strong> требует чтобы было право писать в файл; использование <strong>-lockfile</strong> требует чтобы было право записи в директорию, содержащую файл. Блокировка путём файла не длится вечно; Exim предполагает, что блокировка истекла, если он старее 30 минут.</p>
<p>Параметр <strong>-mbx</strong> может использоваться с одной, или обоими - <strong>-fcntl</strong> или <strong>-flock</strong>. По умолчанию, предполагается <strong>-fcntl</strong>. Блокирока MBX вызывает отключение общей блокировки открытого почтового ящика, и эксклюзивную блокировку на файле <em>/tmp/.n.m</em>, где “n” и “m” - номер устройства и номер иноды файла почтового ящика. Когда блокировка снята, если для почтового ящика может быть получена эксклюзивная блокировка, файл в <em>/tmp</em> - удаляется.</p>
<p>Вывод по умолчанию содержит проверки имеющих место блокировок. Параметр <strong>-v</strong> вызывает выдачу некоторой дополнительной информации. Параметр <strong>-q</strong> подавляет весь вывод, исключая сообщения о ошибках.</p>
<p>Команда типа:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">exim_lock</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">mail</span><span class="o">/</span><span class="n">spqr</span>
</pre></div>
</div>
<p>запускает интерактивный shell, когда файл заблокирован, тогда как:</p>
<div class="highlight-python"><pre>exim_lock -q /var/spool/mail/spqr &lt;&lt;End
&lt;some commands&gt;
End</pre>
</div>
<p>запускает определённую неинтерактивную последовательность команд, когда файл заблокирован, подавляя весь проверочный вывод. Одна команда может быть запущена командой типа:</p>
<div class="highlight-python"><pre>exim_lock -q /var/spool/mail/spqr \
  "cp /var/spool/mail/spqr /some/where"</pre>
</div>
<p>Отметьте, что если команда предоставлена, она должна полностью находиться во втором аргументе, следовательно - в кавычках.</p>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>повторяющимся - прим. lissyara</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td>идентификаторов, наверное - прим. lissyara</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Содержание</a></h3>
  <ul>
<li><a class="reference internal" href="#">Утилиты Exim&#8217;a</a><ul>
<li><a class="reference internal" href="#exim-a-exiwhat">Поиск, что делают процессы Exim&#8217;a (exiwhat)</a></li>
<li><a class="reference internal" href="#exiqgrep">Селективный просмотр очереди (exiqgrep)</a></li>
<li><a class="reference internal" href="#exiqsumm">Подведение итогов очереди (exiqsumm)</a></li>
<li><a class="reference internal" href="#exigrep">Извлечение специфической информации из лога (exigrep)</a></li>
<li><a class="reference internal" href="#exipick">Отбор сообщений по различным критериям (exipick)</a></li>
<li><a class="reference internal" href="#exicyclog">Ротация лог-файлов (exicyclog)</a></li>
<li><a class="reference internal" href="#eximstats">Почтовая статистика (eximstats)</a></li>
<li><a class="reference internal" href="#exim-checkaccess">Проверка политики доступа (exim_checkaccess)</a></li>
<li><a class="reference internal" href="#dbm-exim-dbmbuild">Создание файлов DBM (exim_dbmbuild)</a></li>
<li><a class="reference internal" href="#exinext">Нахождение индивидуальных времён повторов (exinext)</a></li>
<li><a class="reference internal" href="#ch50-11">Обслуживание БД подсказок</a></li>
<li><a class="reference internal" href="#exim-dumpdb">exim_dumpdb</a></li>
<li><a class="reference internal" href="#exim-tidydb">exim_tidydb</a></li>
<li><a class="reference internal" href="#exim-fixdb">exim_fixdb</a></li>
<li><a class="reference internal" href="#exim-lock">Обслуживание почтового ящика (exim_lock)</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="ch49.html" title="предыдущая глава">Файлы логов</a></li>
      <li>Next: <a href="ch51.html" title="следующая глава">Монитор Exim&#8217;a</a></li>
  </ul></li>
</ul>
  <h3>На этой странице</h3>
  <ul class="this-page-menu">
    <li><a href="sources/ch50.txt"
           rel="nofollow">Показать исходный текст</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Быстрый поиск</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Искать" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Введите слова для поиска или имя модуля, класса или функции.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy; Copyright 2011, Exim Maintainers.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
    </div>
  </body>
</html>